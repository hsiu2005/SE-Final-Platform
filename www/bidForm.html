<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>我要出價 | TaskLink</title>
  <link rel="stylesheet" href="/appearance.css" />
  <style>
    /* === 視覺優化 CSS === */

    /* 1. 高度統一：輸入框、按鈕、選單全部 40px */
    .form-control {
      height: 40px;
      font-size: 14px;
      border-radius: 6px;
      padding: 0 12px;
    }
    textarea.form-control {
      height: auto;
      padding: 12px;
      line-height: 1.5;
    }
    input[type="file"].form-control {
      padding: 6px;
      background-color: #fff;
      font-size: 13px;
    }
    
    /* 唯讀欄位淡化 */
    .form-control[readonly] {
      background-color: #f5f5f5;
      color: #666;
      border-color: #e0e0e0;
      cursor: default;
    }

    /* 2. 工具列排版 */
    .btn { white-space: nowrap; }
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    @media (max-width: 900px) {
      .toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-left, .toolbar-actions {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      }
    }

    /* 3. 格線系統 */
    .grid-header {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 24px;
    }
    .grid-split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    @media (max-width: 768px) {
      .grid-header, .grid-split { grid-template-columns: 1fr; gap: 16px; }
    }
  </style>
</head>
<body class="page">
  <div class="page-inner" style="max-width: 1100px;"> 
    
    <header class="page-header">
      <div>
        <h1 class="page-title">我要出價</h1>
        <p class="page-subtitle">
          確認案件資訊，填寫您的報價與執行計畫。
        </p>
      </div>
      <div style="align-self: center;">
         <span id="who" class="who-tag">載入中...</span>
      </div>
    </header>

    <div class="toolbar">
      <div class="toolbar-left" style="display:flex; gap:10px;">
        <a class="btn btn-secondary" href="/contractorJobs.html">← 回案件列表</a>
        <a class="btn btn-secondary" href="/contractorMyJobs.html">我的報價/案件</a>
      </div>

      <div class="toolbar-actions">
        <a class="btn btn-secondary" href="/profile.html">個人頁面</a>
        <a class="btn btn-secondary" href="/closedHistory.html">歷史結案</a>
        <a class="btn btn-secondary" href="/history.html">操作紀錄</a>
        <a class="btn btn-secondary btn-logout" href="/logout">登出</a>
      </div>
    </div>

    <div class="card" style="width: 100%; margin-top: 10px; padding: 50px;"> 
      <div id="msg" class="error-text"></div>

      <form id="bidForm" method="POST" action="/bid/new" class="form" enctype="multipart/form-data">
        
        <div class="grid-header">
          <div class="form-row">
            <label for="jobId" class="form-label">案件 ID</label>
            <input id="jobId" name="job_id" type="text" class="form-control" readonly style="text-align: center;" />
          </div>

          <div class="form-row">
            <label for="jobTitle" class="form-label">案件標題</label>
            <input id="jobTitle" type="text" class="form-control" readonly />
          </div>
        </div>

        <div class="grid-split">
          <div class="form-row">
            <label for="priceInput" class="form-label">出價金額 (TWD)</label>
            <div style="position: relative;">
              <span style="position: absolute; left: 12px; top: 10px; color: #999; font-size: 13px; font-weight: 500;">NT$</span>
              <input
                id="priceInput"
                name="price"
                type="number"
                class="form-control"
                style="padding-left: 48px; font-weight: 600; color: #2c3e34;" 
                required
                inputmode="numeric"
                min="0"
                step="1"
                placeholder="20,000"
              />
            </div>
          </div>

          <div class="form-row">
            <label for="proposal" class="form-label">上傳提案書 (PDF)</label>
            <input
              id="proposal"
              name="proposal_file"
              type="file"
              class="form-control"
              accept="application/pdf"
              required
            />
          </div>
        </div>

        <div class="form-row">
          <label for="note" class="form-label">留言備註 (選填)</label>
          <textarea
            id="note"
            name="note"
            rows="4" 
            class="form-control"
            placeholder="若有特殊需求或工期說明，請在此簡述..."
          ></textarea>
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 32px 0;">

        <div style="display: flex; gap: 16px; justify-content: flex-end;">
          <a class="btn btn-secondary" href="/contractorJobs.html" style="width: 120px;">取消</a>
          <button class="btn btn-primary" type="submit" style="width: 120px;">確認送出</button>
        </div>

      </form>
    </div>
  </div>

  <script>
    async function fetchJSON(url, options = {}) {
      const resp = await fetch(url, options);
      if (resp.status === 401) { location.href = "/loginForm.html"; return null; }
      if (resp.redirected) { location.href = resp.url; return null; }
      if (resp.status === 403) { throw new Error("權限不足"); }
      const ct = resp.headers.get("content-type") || "";
      return ct.includes("application/json") ? resp.json() : resp.text();
    }
    const escapeHTML = (s) => s == null ? "" : String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

    async function loadMe() {
      const me = await fetchJSON("/me");
      if (!me) return;
      document.getElementById("who").textContent = `${me.role === 'client' ? '委託人' : '承包人'} · ${me.username}`;
    }

    const params   = new URLSearchParams(location.search);
    const jobId    = params.get("job_id");
    const titleQ   = params.get("title") || "";
    const priceQ   = params.get("price");

    const jobIdInput    = document.getElementById("jobId");
    const jobTitleInput = document.getElementById("jobTitle");
    const priceInput    = document.getElementById("priceInput");
    const msgBox        = document.getElementById("msg");

    jobIdInput.value    = jobId || "";
    jobTitleInput.value = titleQ;
    if (priceQ !== null && priceQ !== "") priceInput.value = priceQ;

    if (!jobId) {
      msgBox.innerHTML = "<span style='color:#b30000;'>⚠ 錯誤：缺少必要參數 job_id</span>";
      document.querySelector("button[type=submit]").disabled = true;
      document.querySelector("button[type=submit]").style.opacity = "0.5";
    }

    document.getElementById("bidForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      msgBox.textContent = "";

      const formData = new FormData(e.currentTarget);
      try {
        const resp = await fetch(e.currentTarget.action, {
          method: "POST",
          body: formData,
          redirect: "follow",
        });

        if (resp.status === 401) { location.href = "/loginForm.html"; return; }
        if (resp.redirected) { location.href = resp.url; return; }

        const text = await resp.text();
        msgBox.innerHTML = `<span style="color:#b30000;">${text || "回應未知"}</span>`;
      } catch (err) {
        msgBox.innerHTML = `<span style="color:#b30000;">出價失敗：${err}</span>`;
      }
    });

    (async () => {
      try { await loadMe(); } catch (e) { msgBox.textContent = "載入失敗：" + e; }
    })();

    window.addEventListener("pageshow", function (e) { if (e.persisted) location.reload(); });
  </script>
</body>
</html>