<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>委託人：我的案件</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body class="page">
  <div class="page-inner">
    <header class="page-header">
      <div>
        <h1 class="page-title">委託人：我的案件</h1>
        <p class="page-subtitle">
          在這裡管理您已建立的所有案件，查看報價與進度。
        </p>
      </div>
      <span id="who" class="who-tag"></span>
    </header>

    <div class="toolbar">
      <div class="toolbar-main">
        <a class="btn btn-primary btn-wide" href="/jobNew.html">＋ 新增案件</a>
      </div>
      <div class="toolbar-extra">
        <a class="btn btn-secondary" href="/history.html">查看歷史紀錄</a>
        <a class="btn btn-secondary" href="/logout">切換帳號</a>
        <a class="btn btn-secondary" href="/logout">登出</a>
      </div>
    </div>

    <div class="card">
      <div id="error" class="error-text"></div>
      <div class="table-wrapper">
        <table id="jobsTable" class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>標題</th>
              <th>狀態</th>
              <th>得標承包人</th>
              <th>報價數</th>
              <th>動作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="reviewModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeReviewModal()">&times;</span>
      <h2 style="margin-top:0;">評價紀錄</h2>
      <div id="modal-loading" class="muted">載入中...</div>
      <div id="modal-body" style="display:none;">
        <div style="background:#fffaf1; padding:12px; border-radius:8px; margin-bottom:16px;">
          <div style="font-size:1.2em; font-weight:bold; color:#f5c518;">平均 <span id="modal-avg"></span> 分 <span style="font-size:0.6em; color:#666;">(共 <span id="modal-count"></span> 筆)</span></div>
          <div class="muted" style="font-size:0.9em; margin-top:4px;" id="modal-dims"></div>
        </div>
        <div id="modal-list" style="max-height:300px; overflow-y:auto;"></div>
      </div>
    </div>
  </div>

  <script>
    async function fetchJSON(url, options = {}) {
      const resp = await fetch(url, options);
      if (resp.status === 401 || resp.redirected) {
        window.location.href = "/loginForm.html";
        return null;
      }
      if (resp.status === 403) { throw new Error("權限不足"); }
      const ct = resp.headers.get("content-type") || "";
      return ct.includes("application/json") ? resp.json() : resp.text();
    }

    const escapeHTML = s => s == null ? "" : String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    const fmtDate=iso=>iso?new Date(iso).toLocaleDateString():"";

    // Modal JS
    const reviewModal = document.getElementById("reviewModal");
    function closeReviewModal() { reviewModal.style.display = "none"; }
    window.onclick = function(event) { if (event.target == reviewModal) closeReviewModal(); }

    // 產生星星 HTML
    // role 參數傳入 'contractor'，因為我們是要看承包人的評價
    function renderStars(score, userId, role) {
        if (score == null) return ''; // 若沒有人得標或沒分數，就不顯示
        return `<div style="margin-top:2px; font-size:0.9em; cursor:pointer;" onclick="openReviewModal(${userId}, '${role}')" title="點擊查看詳細評論">
                <span style="color:#f5c518;">★</span> 
                <span style="text-decoration:underline; color:#555;">${Number(score).toFixed(1)}</span></div>`;
    }

    // 開啟評價詳情
    async function openReviewModal(userId, role) {
      reviewModal.style.display = "block";
      document.getElementById("modal-loading").style.display = "block";
      document.getElementById("modal-body").style.display = "none";
      try {
        const data = await fetchJSON(`/api/reviews/${userId}?role=${role}`);
        if (!data) return;
        const stats = data.stats;
        document.getElementById("modal-avg").textContent = Number(stats.avg_total||0).toFixed(1);
        document.getElementById("modal-count").textContent = stats.count;
        
        // 委託人看承包人，維度顯示：
        let dimNames = ["產出品質", "執行效率", "合作態度"];
        document.getElementById("modal-dims").innerHTML = `${dimNames[0]}: <b>${Number(stats.avg_r1||0).toFixed(1)}</b> | ${dimNames[1]}: <b>${Number(stats.avg_r2||0).toFixed(1)}</b> | ${dimNames[2]}: <b>${Number(stats.avg_r3||0).toFixed(1)}</b>`;
        
        const listEl = document.getElementById("modal-list");
        listEl.innerHTML = "";
        if (data.comments.length === 0) listEl.innerHTML = `<div class="review-empty">無文字評論</div>`;
        else {
          data.comments.forEach(c => {
            const div = document.createElement("div");
            div.className = "review-item";
            div.innerHTML = `<div class="review-header"><span><b>${escapeHTML(c.from_name)}</b> <span class="muted">(${fmtDate(c.created_at)})</span></span><span class="review-stars">★ ${((c.rating_1+c.rating_2+c.rating_3)/3).toFixed(1)}</span></div><div class="review-text">${c.comment?escapeHTML(c.comment):'<span class="muted">無文字</span>'}</div>`;
            listEl.appendChild(div);
          });
        }
        document.getElementById("modal-loading").style.display = "none";
        document.getElementById("modal-body").style.display = "block";
      } catch (e) { alert("Error: "+e); closeReviewModal(); }
    }

    async function loadJobs() {
      try {
        // 1. 取得使用者資訊 (包含自己的評分)
        const me = await fetchJSON("/me");
        if (me) {
            const starText = me.rating 
              ? ` <span style="color:#f5c518; margin-left:5px;">★ ${Number(me.rating).toFixed(1)}</span>` 
              : "";
            document.getElementById("who").innerHTML = `登入中：${me.role} ${me.username}${starText}`;
        }

        // 2. 取得案件列表
        const data = await fetchJSON("/client/jobs");
        if (!data) return;

        const tbody = document.querySelector("#jobsTable tbody");
        tbody.innerHTML = "";

        if (!data.items || data.items.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="6" class="text-muted" style="text-align:center;">尚未建立任何案件</td>`;
          tbody.appendChild(tr);
          return;
        }

        for (const j of data.items) {
          const tr = document.createElement("tr");

          let contractorContent = '<span class="text-muted">—</span>';
          if (j.contractor_name) {
              // 這裡呼叫 renderStars，顯示得標者的星星
              const stars = renderStars(j.contractor_avg_rating, j.contractor_id, 'contractor');
              contractorContent = `${escapeHTML(j.contractor_name)}<br>${stars}`;
          }
          
          let statusBadge = escapeHTML(j.status);
          if(j.status === 'closed') statusBadge = `<span class="badge badge-green">已結案</span>`;
          else if(j.status === 'pending') statusBadge = `<span class="text-muted">等待報價</span>`;

          tr.innerHTML = `
            <td>${j.id}</td>
            <td>${escapeHTML(j.title)}</td>
            <td>${statusBadge}</td>
            <td>${contractorContent}</td>
            <td>${j.bid_count ?? 0}</td>
            <td><a class="btn btn-secondary btn-sm" href="/jobDetail.html?job_id=${j.id}">查看詳情</a></td>
          `;
          tbody.appendChild(tr);
        }
      } catch (e) {
        document.getElementById("error").textContent = "載入失敗：" + e;
      }
    }

    (async () => { await loadJobs(); })();
    window.addEventListener("pageshow", function (e) { if (e.persisted) location.reload(); });
  </script>
</body>
</html>