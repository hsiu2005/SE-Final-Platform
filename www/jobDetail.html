<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>案件詳情 | TaskLink</title>
  <link rel="stylesheet" href="/appearance.css">
  <style>
    /* === 1. 頁面專屬排版 (1100px 寬度) === */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .toolbar .btn { white-space: nowrap; }
    
    @media (max-width: 900px) {
      .toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-left, .toolbar-actions {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      }
    }

    /* 2. 卡片優化 */
    .card {
      margin-top: 20px;
      padding: 32px; /* 寬鬆內距 */
    }
    
    /* 3. 標題與分隔 */
    h2, .panel-title {
      margin: 0 0 20px;
      font-size: 18px;
      font-weight: 700;
      color: #2c3e34;
      border-bottom: 1px solid #eee;
      padding-bottom: 12px;
    }

    /* 4. 案件資訊表格美化 */
    .job-info-table th {
      width: 120px;
      color: #666;
      font-weight: 600;
      background-color: transparent; /* 去除原本的黃底 */
      border-bottom: 1px solid #f0f0f0;
      padding: 12px 8px;
    }
    .job-info-table td {
      border-bottom: 1px solid #f0f0f0;
      color: #333;
      padding: 12px 8px;
      line-height: 1.6;
    }

    /* 5. 狀態提示框 (Alerts) */
    .status-alert {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.6;
      display: flex;
      align-items: start;
      gap: 10px;
    }
    .alert-success { background-color: #e8f5e9; border: 1px solid #c8e6c9; color: #1b5e20; }
    .alert-danger  { background-color: #ffebee; border: 1px solid #ffcdd2; color: #b71c1c; }
    .alert-info    { background-color: #e3f2fd; border: 1px solid #bbdefb; color: #0d47a1; }

    /* 6. 特殊按鈕顏色 (Success/Danger) */
    .btn-danger {
      background-color: #fff;
      border: 1px solid #ffcdd2;
      color: #c62828;
    }
    .btn-danger:hover {
      background-color: #ffebee;
      border-color: #ef9a9a;
    }
    
    .btn-success {
      background-color: #2e7d32;
      color: #fff;
      border: 1px solid #2e7d32;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.2);
    }
    .btn-success:hover {
      background-color: #1b5e20;
      transform: translateY(-1px);
    }

    /* 7. 評價星星 */
    .stars {
      position: relative;
      display: inline-block;
      font-size: 16px;
      line-height: 1;
      letter-spacing: 2px;
      color: #e0e0e0;
    }
    .stars::before { content: "★★★★★"; }
    .stars::after {
      content: "★★★★★";
      color: #f5c518;
      position: absolute;
      left: 0;
      top: 0;
      width: var(--pct, 0%);
      overflow: hidden;
    }

    /* 8. 狀態膠囊 (Badges) */
    .badge-pill {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 4px 12px; border-radius: 6px; font-size: 13px; font-weight: 600;
      border: 1px solid transparent; white-space: nowrap;
    }
    .st-blue   { background: #e3f2fd; color: #1565c0; border-color: #bbdefb; }
    .st-orange { background: #fff3e0; color: #e65100; border-color: #ffe0b2; }
    .st-purple { background: #f3e5f5; color: #7b1fa2; border-color: #e1bee7; }
    .st-indigo { background: #e8eaf6; color: #3f51b5; border-color: #c5cae9; }
    .st-red    { background: #ffebee; color: #c62828; border-color: #ffcdd2; }
    .st-green  { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
    .st-gray   { background: #f5f5f5; color: #616161; border-color: #e0e0e0; }

    /* Issue & Comment 列表樣式 */
    .issue-item {
      border: 1px solid #f0f0f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .comment-item {
      background: #fafafa;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 14px;
    }

    /* ===== Issue Tracker v2 (match TaskLink style) ===== */
    #issue-panel { padding: 28px; }
    #issue-panel h2 { margin-bottom: 14px; }

    .issue-create {
      background: #fcfdff;
      border: 1px solid #e3f2fd;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 16px;
    }

    .issue-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .issue-item {
      border: 1px solid #eef2f3;
      border-radius: 12px;
      padding: 14px;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }

    .issue-head {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      margin-bottom: 8px;
    }

    .issue-title {
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
    }

    .issue-title b{
      font-size: 15px;
      color:#2c3e34;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 520px;
    }

    .issue-meta {
      font-size: 12px;
      color: #6b7280;
      white-space: nowrap;
    }

    .issue-desc {
      color:#555;
      font-size: 14px;
      line-height: 1.6;
      margin: 8px 0 10px;

      /* ✅ 防止超出去：長字串/網址/亂碼都會斷行 */
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .issue-actions {
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .issue-comments {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #f1f5f9;
    }

    .comment-item {
      background: #f9fafb;
      border: 1px solid #eef2f3;
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }

    .comment-head {
      display:flex;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
      font-size: 12px;
      color: #6b7280;
    }

    .comment-body {
      font-size: 14px;
      color: #374151;
      line-height: 1.6;

      /* ✅ 防止超出去 */
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .issue-comment-form{
      display:flex;
      gap:8px;
      margin-top: 10px;
    }

    .issue-comment-form input{
      flex:1;
    }

    /* badge 文字更像你上面 */
    .badge-pill.st-orange { font-size:12px; padding: 3px 10px; border-radius: 999px; }
    .badge-pill.st-gray { font-size:12px; padding: 3px 10px; border-radius: 999px; }

    .issue-item, .comment-item { min-width: 0; }
    .issue-head { min-width: 0; }


  </style>
</head>
<body class="page">
  <div class="page-inner" style="max-width: 1100px;">
    
    <header class="page-header">
      <div>
        <h1 class="page-title">案件詳情：<span id="jobTitle">載入中...</span></h1>
        <p class="page-subtitle">查看案件詳細規格、報價狀況與執行進度。</p>
      </div>
      <div style="align-self: center;">
         <span id="who" class="who-tag"></span>
      </div>
    </header>

    <div class="toolbar">
      <div class="toolbar-left" id="backLinkContainer" style="display:flex;">
        <a class="btn btn-secondary" href="/">回列表</a> 
      </div>

      <div class="toolbar-actions" style="display:flex; gap:8px;">
        <a class="btn btn-secondary" href="/profile.html">個人頁面</a>
        <a class="btn btn-secondary" href="/closedHistory.html">歷史結案</a>
        <a class="btn btn-secondary" href="/history.html">操作紀錄</a>
        <a class="btn btn-secondary btn-logout" href="/logout">登出</a>
      </div>
    </div>

    <div id="error" class="error-text"></div>
    <div id="status-alert-panel" style="display:none;"></div>

    <div class="card">
      <h2>案件資訊</h2>
      <table class="table job-info-table">
        <tr><th style="width:120px;">ID</th><td id="info-id"></td></tr>
        <tr><th>目前狀態</th><td id="info-status"></td></tr>
        <tr><th>委託人</th><td id="info-client"></td></tr>
        <tr><th>案件內容</th><td id="info-content" style="white-space: pre-wrap;"></td></tr>
        <tr><th>預算</th><td id="info-budget"></td></tr>
        <tr><th>截止日期</th><td id="info-due-date"></td></tr>
      </table>
    </div>

    <div id="client-rating-summary" class="card" style="display:none;"></div>

    <div id="client-panel" style="display:none;">
      
      <div id="client-bids-panel" class="card">
        <h2>報價列表</h2>
        <div class="table-wrapper">
          <table id="bidsTable" class="table">
            <thead>
              <tr>
                <th>承包人</th>
                <th>報價金額</th>
                <th>留言備註</th>
                <th>提案書</th>
                <th style="width:140px;">操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="client-review-panel" class="card" style="display:none; border: 1px solid #bbdefb; background-color: #fcfdff;">
        <h2 style="color: #1565c0; border-bottom-color: #bbdefb;">驗收成果</h2>
        <div style="background:#fff; padding:16px; border-radius:8px; margin-bottom:20px; border:1px solid #e3f2fd;">
          <p style="margin:0 0 10px;">承包人已上傳結案成果，請下載確認：</p>
          <a id="download-link" href="#" class="btn btn-primary" download>下載結案檔案</a>
        </div>
        
        <form action="/job/review" method="POST">
          <input type="hidden" name="job_id" id="review-job-id">
          <label class="form-label" style="display:block; margin-bottom:8px;">審核結果與回饋：</label>
          <textarea name="message" class="form-control" rows="3" placeholder="若選擇退件，請務必在此說明修改建議..." style="margin-bottom:16px;"></textarea>
          
          <div style="display:flex; gap:12px;">
            <button class="btn btn-success" type="submit" name="decision" value="closed">✓ 驗收通過 (結案)</button>
            <button class="btn btn-danger" type="submit" name="decision" value="rejected">✕ 退件 (要求重傳)</button>
          </div>
        </form>
      </div>

      <div id="client-accepted-panel" class="card" style="display:none;">
        <h2>最終承接資訊</h2>
        <table class="table job-info-table">
          <tr id="win-contractor-row"><th>承接廠商</th><td id="win-contractor"></td></tr>
          <tr id="win-price-row"><th>承接金額</th><td id="win-price"></td></tr>
          <tr id="win-note-row"><th>廠商備註</th><td id="win-note"></td></tr>
          <tr id="win-proposal-row"><th>提案書</th><td id="win-proposal"></td></tr>
        </table>
      </div>
    </div>

    <div id="contractor-panel" style="display:none;">
      
      <div id="contractor-invite-panel" class="card" style="display:none; border: 1px solid #ffe0b2; background-color: #fffaf5;">
        <h2 style="color: #e65100; border-bottom-color: #ffe0b2;">邀請通知</h2>
        <p style="font-size:15px; margin-bottom:20px;">
          委託人 <b id="invite-client-name"></b> 邀請您承接此案件，預算為 <b id="invite-price" style="color:#e65100;"></b>。
        </p>
        <div style="display:flex; gap:12px;">
          <form action="/invitation/accept" method="POST" style="margin:0;">
            <input type="hidden" name="job_id" id="invite-job-id-acc" />
            <button class="btn btn-success" type="submit">接受邀請</button>
          </form>
          <form action="/invitation/decline" method="POST" style="margin:0;" onsubmit="return confirm('確定要婉拒嗎？婉拒後案件將轉為公開。')">
            <input type="hidden" name="job_id" id="invite-job-id-dec" />
            <button class="btn btn-danger" type="submit">婉拒</button>
          </form>
        </div>
      </div>

      <div id="contractor-win-panel" class="card" style="display:none;">
        <h2>您的得標資訊</h2>
        <table class="table job-info-table">
          <tr><th>您的報價</th><td id="my-win-price"></td></tr>
          <tr><th>備註</th><td id="my-win-note"></td></tr>
          <tr><th>提案書</th><td id="my-win-proposal"></td></tr>
        </table>
      </div>

      <div id="contractor-invite-win-panel" class="card" style="display:none;">
        <h2>您的承接資訊</h2>
        <table class="table job-info-table">
          <tr><th>承接預算</th><td id="my-invite-win-price"></td></tr>
        </table>
      </div>

      <div id="contractor-upload-panel" class="card" style="display:none; border: 1px solid #bbdefb;">
        <h2 style="color:#1565c0; border-bottom-color:#bbdefb;">上傳結案成果</h2>
        <p class="text-muted" style="margin-bottom:16px;">恭喜您承接此案件！請在執行完畢後，於此處上傳結案報告或檔案。</p>
        <form action="/job/upload" method="POST" enctype="multipart/form-data">
          <input type="hidden" name="job_id" id="upload-job-id">
          <div style="margin-bottom:16px;">
            <input type="file" name="report_file" class="form-control" required style="height:auto; padding:8px; background:#fff;">
          </div>
          <button class="btn btn-primary" type="submit">上傳檔案並提交驗收</button>
        </form>
      </div>

      <div id="contractor-review-panel" class="card" style="display:none;">
        <h2>等待驗收中</h2>
        <p>您已上傳檔案，目前正在等待委託人審核。</p>
        <div style="margin-top:16px;">
           <a id="contractor-download-link" href="#" class="btn btn-secondary" download>下載您上傳的檔案</a>
        </div>
      </div>
    </div>

    <div id="visitor-panel" class="card" style="display:none;"></div>

    <div id="result-history-panel" class="card" style="display:none;"></div>

    <div id="issue-panel" class="card" style="display:none;"></div>
    
    <div id="rating-panel" class="card" style="display:none;"></div>

  </div>

  <div id="ratingModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9999; align-items:center; justify-content:center;">
    <div style="width:100%; max-width:600px; background:#fff; border-radius:12px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.2); max-height:80vh; overflow-y:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <div id="ratingModalTitle" style="font-weight:700; font-size:20px;"></div>
        <button class="btn btn-secondary btn-sm" type="button" id="ratingModalClose">✕ 關閉</button>
      </div>
      <div id="ratingModalBody"></div>
    </div>
  </div>

  <script>
    /* ======================================================
       Javascript 邏輯區
       ====================================================== */


    // 狀態膠囊產生器
    function getStatusBadge(status) {
      const map = {
        "pending":  { text: "待選標", cls: "st-blue" },
        "invited":  { text: "邀請中", cls: "st-orange" },
        "accepted": { text: "進行中", cls: "st-purple" },
        "uploaded": { text: "待驗收", cls: "st-indigo" },
        "rejected": { text: "被退件", cls: "st-red" },
        "closed":   { text: "已結案", cls: "st-green" }
      };
      const item = map[status] || { text: status || "未知", cls: "st-gray" };
      return `<span class="badge-pill ${item.cls}">${item.text}</span>`;
    }

    function starsHTML(avg) {
      const v = Math.max(0, Math.min(5, Number(avg || 0)));
      const pct = (v / 5) * 100;
      return `<span class="stars" style="--pct:${pct}%;"></span>`;
    }

    async function fetchJSON(url, options={}) {
      const resp = await fetch(url, options);
      if (resp.status === 401) { window.location.href="/loginForm.html"; return null; }
      if (resp.redirected) { window.location.href = resp.url; return null; }
      if (!resp.ok) {
        const errText = await resp.text();
        document.getElementById("error").textContent = `API 錯誤 ${resp.status}: ${errText}`;
        return null;
      }
      return await resp.json();
    }

    const escapeHTML = s => s==null ? "" : String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const currency = new Intl.NumberFormat("zh-Hant-TW", { style:"currency", currency:"TWD", maximumFractionDigits:0 });
    const fmtMoney = n => (n==null ? "N/A" : currency.format(Number(n)));
    const fmtDate = s => s ? new Date(s).toLocaleDateString("zh-Hant-TW") : "—";
    const fmtDateTime = s => s ? new Date(s).toLocaleString("zh-Hant-TW") : "—";

    const params = new URLSearchParams(location.search);
    const jobId = params.get("job_id");

    const RATING_DIM_LABELS_BY_TARGET = {
      client: ["需求合理性", "驗收難度", "合作態度"],
      contractor: ["產出品質", "執行效率", "合作態度"]
    };

    // ✅ 顯示後端 redirect 帶回來的訊息（toast=...）
    (function showToastFromQuery(){
      const p = new URLSearchParams(location.search);
      const toast = p.get("toast");
      if (!toast) return;

      const box = document.getElementById("status-alert-panel");
      if (box) {
        box.innerHTML += `<div class="status-alert alert-info"><b>提示：</b>${escapeHTML(toast)}</div>`;
        box.style.display = "block";
      }

      // 清掉 query，避免重新整理又跳一次
      p.delete("toast");
      const qs = p.toString();
      history.replaceState(null, "", location.pathname + (qs ? "?" + qs : ""));
    })();


    // 渲染評價摘要
    async function renderUserRatingSummary(targetUserId, asTargetRole, mountEl) {
      const resp = await fetch(`/user/${targetUserId}/rating-summary?as_target_role=${asTargetRole}`, { credentials: "include" });
      if (!resp.ok) {
        mountEl.innerHTML = `<p class="text-muted">（無法取得評價資料）</p>`;
        return;
      }
      const json = await resp.json();
      if (!json.success) {
        mountEl.innerHTML = `<h2>過往評價</h2><p class="text-muted">（目前沒有評價資料）</p>`;
        return;
      }

      const d = json.data || {};
      const allComments = (d.recent_comments || []);
      const comments = allComments.slice(0, 3);
      const labels = RATING_DIM_LABELS_BY_TARGET[asTargetRole] || ["D1","D2","D3"];

      mountEl.innerHTML = `
        <h2 style="margin-bottom:12px;">過往評價（${asTargetRole === "client" ? "委託人" : "承包人"}）</h2>
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
          ${starsHTML(d.avg_overall)}
          <span style="font-size:18px; font-weight:700; color:#333;">${Number(d.avg_overall || 0).toFixed(1)}</span>
          <span class="text-muted">（共 ${d.count || 0} 筆）</span>
        </div>
        <div class="text-muted" style="font-size:13px; margin-bottom:16px;">
          ${labels[0]}：<b>${Number(d.avg_dim1||0).toFixed(1)}</b>　
          ${labels[1]}：<b>${Number(d.avg_dim2||0).toFixed(1)}</b>　
          ${labels[2]}：<b>${Number(d.avg_dim3||0).toFixed(1)}</b>
        </div>
        
        <div style="background:#fcfcfc; padding:16px; border-radius:8px; border:1px solid #eee;">
          <div style="font-weight:600; margin-bottom:12px;">近期評論：</div>
          ${comments.length === 0 ? `<div class="text-muted">（無留言）</div>` : comments.map(c => `
            <div style="border-bottom:1px solid #f0f0f0; padding-bottom:10px; margin-bottom:10px;">
              <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;">
                <b>${escapeHTML(c.from_name || "匿名")}</b>
                <span class="text-muted">${c.created_at ? fmtDate(c.created_at) : ""}</span>
              </div>
              <div style="font-size:14px; color:#444;">${escapeHTML(c.comment || "")}</div>
            </div>
          `).join("")}
          ${allComments.length > 3 ? `<button class="btn btn-secondary btn-sm" id="openAllCommentsBtn" style="width:100%;">查看全部 ${allComments.length} 則留言</button>` : ""}
        </div>
      `;

      const btn = mountEl.querySelector("#openAllCommentsBtn");
      if (btn) {
        btn.addEventListener("click", () => {
          openRatingModal(`全部留言（${asTargetRole === "client" ? "委託人" : "承包人"}）`, allComments);
        });
      }
    }

    // Modal 控制
    function openRatingModal(title, comments) {
      document.getElementById("ratingModalTitle").textContent = title;
      const body = document.getElementById("ratingModalBody");
      if (!comments.length) {
        body.innerHTML = "<p class='text-muted'>沒有更多留言。</p>";
      } else {
        body.innerHTML = comments.map(c => `
          <div style="border-bottom:1px solid #eee; padding-bottom:12px; margin-bottom:12px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
              <b>${escapeHTML(c.from_name||"匿名")}</b>
              <small class="text-muted">${fmtDate(c.created_at)}</small>
            </div>
            <div style="color:#333;">${escapeHTML(c.comment)}</div>
          </div>
        `).join("");
      }
      document.getElementById("ratingModal").style.display = "flex";
    }
    document.getElementById("ratingModalClose").onclick = () => document.getElementById("ratingModal").style.display = "none";

    document.getElementById("ratingModal").addEventListener("click", (e) => {
      if (e.target.id === "ratingModal") document.getElementById("ratingModal").style.display = "none";
    });


    // Issue Panel 載入
    async function loadIssuesPanel(jobId, role, jobStatus) {
      const panel = document.getElementById("issue-panel");
      if (!panel) return;
      panel.innerHTML = "";
      panel.style.display = "block";

      let issues = [];
      try {
       const resp = await fetch(`/job/${jobId}/issues?_t=${Date.now()}`, {
        credentials: "include",
        cache: "no-store",
      });

        if (resp.ok) {
          const payload = await resp.json();
          console.log("[issues] payload =", payload);

          issues = payload?.data?.issues ?? payload?.issues ?? payload?.data ?? payload ?? [];
          console.log("[issues] parsed issues =", issues, "len=", Array.isArray(issues) ? issues.length : "not array");
        }

      } catch (e) {
        console.error(e);
        panel.innerHTML = `<p class="text-muted">無法載入 Issue。</p>`;
        return;
      }

      let html = `<h2>Issue Tracker</h2>`;

      // 委託人：可建立 Issue (僅在 uploaded/rejected)
      if (role === "client") {
        if (jobStatus === "uploaded" || jobStatus === "rejected") {
          html += `
            <form id="issueCreateForm" method="post" action="/job/issue/new" style="margin-bottom:20px;; background:#f9f9f9; padding:16px; border-radius:8px;">
              <input type="hidden" name="job_id" value="${jobId}">
              <div style="margin-bottom:8px;">
                <input name="title" class="form-control" placeholder="Issue 標題" required style="width:100%; margin-bottom:8px;">
                <textarea name="description" class="form-control" rows="2" placeholder="Issue 描述" style="width:100%;"></textarea>
              </div>
              <button class="btn btn-primary btn-sm" type="submit">新增 Issue</button>
            </form>
          `;
        } else {
          html += `<p class="text-muted" style="margin-bottom:16px;">目前狀態需承包人上傳成果後才能建立 Issue。</p>`;
        }
      }

      if (issues.length === 0) {
        html += `<p class="text-muted">目前沒有 Issue。</p>`;
        panel.innerHTML = html;
        return;
      }

      issues.forEach(issue => {
        const isClosed = (issue.status === "closed");
        const badgeCls = isClosed ? "st-gray" : "st-orange";
        const badgeText = isClosed ? "closed" : "open";

        html += `
          <div class="issue-item">
            <div class="issue-head">
              <div class="issue-title">
                <span class="badge-pill ${badgeCls}">${badgeText}</span>
                <b title="${escapeHTML(issue.title)}">${escapeHTML(issue.title)}</b>
              </div>
              <div class="issue-meta">${escapeHTML(issue.creator_name || "匿名")} · ${fmtDate(issue.created_at)}</div>
            </div>

            <div class="issue-desc">${escapeHTML(issue.description || "（無描述）")}</div>
        `;

        if (role === "client" && !isClosed) {
          html += `
            <div class="issue-actions">
              <form method="post" action="/job/issue/close" style="margin:0;">
                <input type="hidden" name="issue_id" value="${issue.id}">
                <button class="btn btn-success btn-sm" type="submit">✓ 標記為完成</button>
              </form>
            </div>
          `;
        }

        html += `<div class="issue-comments">`;

        (issue.comments || []).forEach(c => {
          const author = c.author_name || c.author_username || "匿名";
          html += `
            <div class="comment-item">
              <div class="comment-head">
                <div><b>${escapeHTML(author)}</b></div>
                <div>${fmtDate(c.created_at)}</div>
              </div>
              <div class="comment-body">${escapeHTML(c.content || "")}</div>
            </div>
          `;
        });

        html += `
            <form class="issue-comment-form" method="post" action="/job/issue/comment">
              <input type="hidden" name="issue_id" value="${issue.id}">
              <input name="content" class="form-control"
                placeholder="${isClosed ? "已關閉，無法留言" : "新增留言..."}"
                ${isClosed ? "disabled" : ""} required>
              <button class="btn btn-secondary" type="submit" ${isClosed ? "disabled" : ""}>送出</button>
            </form>
          </div>
        </div>
        `;
      });


      panel.innerHTML = html;

      // ✅ 新增 Issue：用 fetch 送出，成功後立刻刷新列表
      const createForm = panel.querySelector("#issueCreateForm");
      if (createForm) {
        createForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const fd = new FormData(createForm);
          const resp = await fetch(createForm.action, {
            method: "POST",
            body: fd,
            credentials: "include",
            redirect: "follow",
            cache: "no-store",
          });

          // 後端如果 redirect，就直接跟著跳（通常會帶 toast）
          if (resp.redirected) {
            window.location.href = resp.url;
            return;
          }

          // 如果後端回 OK（不 redirect），就直接刷新 issue 列表
          if (resp.ok) {
            await loadIssuesPanel(jobId, role, jobStatus);
            return;
          }

          const t = await resp.text().catch(() => "");
          alert(`新增 Issue 失敗：HTTP ${resp.status}\n${t}`);
        });
      }

    }

    // 評價表單鎖定
    async function lockRatingFormIfRated(jobId) {
      const form = document.querySelector("#rating-panel form");
      if (!form) return;
      const meResp = await fetch("/me", {credentials:"include"});
      if (!meResp.ok) return;
      const me = await meResp.json();
      
      const resp = await fetch(`/job/${jobId}/ratings`, {credentials:"include"});
      if(!resp.ok) return;
      const payload = await resp.json();
      const ratings = payload?.data?.ratings ?? payload?.ratings ?? [];
      
      const action = form.getAttribute("action") || "";
      const myTargetRole = action.includes("rate-client") ? "client" : "contractor";
      
      if (ratings.some(r => Number(r.rater_id) === Number(me.user_id) && r.target_role === myTargetRole)) {
        form.querySelectorAll("input, textarea, button").forEach(el => el.disabled = true);
        const box = document.getElementById("status-alert-panel");
        // 疊加內容，不要覆蓋
        box.innerHTML += `<div class="status-alert alert-info"><b>已完成評價</b>：您已送出評價，無法修改。</div>`;
        box.style.display = "block";
      }
    }

    // 渲染 Rating Panel
    function renderRatingPanel(job, role) {
      const panel = document.getElementById("rating-panel");
      if (!panel) return;
      if (job.status !== "closed") { panel.style.display = "none"; return; }

      let action="", title="", targetRole="";
      if (role === "client" && job.contractor_id) {
        action = "/job/rate-contractor";
        targetRole = "contractor";
        title = `評價承包人：${escapeHTML(job.contractor_name)}`;
      } else if (role === "contractor") {
        action = "/job/rate-client";
        targetRole = "client";
        title = `評價委託人：${escapeHTML(job.client_name)}`;
      } else {
        panel.style.display = "none"; return;
      }

      const labels = RATING_DIM_LABELS_BY_TARGET[targetRole] || ["D1","D2","D3"];
      panel.innerHTML = `
        <h2>合作評價</h2>
        <p class="text-muted" style="margin-bottom:12px;">${title}</p>
        <div id="rating-deadline-hint" class="status-alert alert-info" style="display:none; margin-bottom:16px;"></div>
        
        <form method="post" action="${action}">
          <input type="hidden" name="job_id" value="${job.id}">
          <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; margin-bottom:20px;">
            <label style="display:block; font-weight:600; margin-bottom:4px;">${labels[0]}
              <input type="number" name="dim1" min="1" max="5" class="form-control" required style="margin-top:4px;">
            </label>
            <label style="display:block; font-weight:600; margin-bottom:4px;">${labels[1]}
              <input type="number" name="dim2" min="1" max="5" class="form-control" required style="margin-top:4px;">
            </label>
            <label style="display:block; font-weight:600; margin-bottom:4px;">${labels[2]}
              <input type="number" name="dim3" min="1" max="5" class="form-control" required style="margin-top:4px;">
            </label>
          </div>
          <div style="margin-bottom:20px;">
            <label style="display:block; font-weight:600; margin-bottom:4px;">評論（選填）：</label>
            <textarea name="comment" class="form-control" rows="3" placeholder="寫下您的評論..."></textarea>
          </div>
          <button class="btn btn-primary" type="submit">送出評價</button>
        </form>
        <div id="rating-result" style="margin-top:20px;"></div>
      `;
      panel.style.display = "block";
      
      // 綁定送出
      const form = panel.querySelector("form");
      form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const resp = await fetch(action, { method:"POST", body:fd, credentials:"include", redirect:"follow" });
        if(resp.status===409) { alert("已評價過"); return; }
        if(resp.redirected) { window.location.href = resp.url; return; }
        if(!resp.ok) { alert("評價失敗"); return; }
        window.location.reload();
      });
    }

    async function loadRatingDeadlineHint(jobId) {
      const hint = document.getElementById("rating-deadline-hint");
      if(!hint) return;
      try {
        const resp = await fetch(`/job/${jobId}/rating-window`, {credentials:"include"});
        if(resp.ok) {
          const w = await resp.json();
          if(w.deadline_at) {
            const date = new Date(w.deadline_at).toLocaleString("zh-Hant-TW");
            hint.innerHTML = `<b>評價期限至：</b>${date}` + (w.expired ? " <span style='color:red;'>(已逾期)</span>" : "");
            hint.style.display = "block";
            if(w.expired) document.querySelector("#rating-panel form button").disabled = true;
          }
        }
      } catch(e){}
    }

    async function loadRatingsPanel(jobId) {
      const box = document.getElementById("rating-result");
      if(!box) return;
      try {
        const resp = await fetch(`/job/${jobId}/ratings`, {credentials:"include"});
        if(resp.ok) {
          const payload = await resp.json();
          const ratings = payload?.data?.ratings ?? payload?.ratings ?? [];
          if(ratings.length===0) return;
          
          let html = `<h3 style="font-size:16px; margin-bottom:10px;">此案件評價紀錄</h3>`;
          ratings.forEach(r => {
             const labels = RATING_DIM_LABELS_BY_TARGET[r.target_role] || ["D1","D2","D3"];
             html += `
               <div style="background:#fafafa; padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid #eee;">
                 <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                   <span><b>${escapeHTML(r.rater_name||"User")}</b> 評 <b>${r.target_role}</b></span>
                   <small class="text-muted">${fmtDate(r.created_at)}</small>
                 </div>
                 <div class="text-muted" style="font-size:13px; margin:4px 0;">
                   ${labels[0]}: ${r.dim1}, ${labels[1]}: ${r.dim2}, ${labels[2]}: ${r.dim3}
                 </div>
                 <div style="margin-top:6px; color:#444;">${escapeHTML(r.comment||"")}</div>
               </div>
             `;
          });
          box.innerHTML = html;
        }
      } catch(e){}
    }

    async function initExtensionPanels() {
      if (!jobId) return;
      const me = await fetchJSON("/me");
      if (!me) return;
      const data = await fetchJSON(`/job/${jobId}/detail`);
      if (!data) return;
      const job = data.job;
      
      const roleRaw = data.user_job_role;
      const role = (roleRaw === "visitor_contractor") ? "visitor" : roleRaw;
      const isContractorLike = (roleRaw === "contractor" || roleRaw === "visitor_contractor");
      
      const isClient = (role === "client");
      const isWinnerContractor = (job.contractor_id && me.user_id === job.contractor_id);
      const canUseIssue = isClient || isWinnerContractor;
      
      const extensionRole = isClient ? "client" : isWinnerContractor ? "contractor" : (isContractorLike ? "visitor" : role);

      if (canUseIssue) {
        await loadIssuesPanel(job.id, extensionRole, job.status);
      }
      
      if (job.status === "closed") {
        renderRatingPanel(job, extensionRole);
        await loadRatingDeadlineHint(job.id);
        await loadRatingsPanel(job.id);
        await lockRatingFormIfRated(job.id);
      }
    }

    async function loadPage() {
      if (!jobId) { document.getElementById("error").textContent = "錯誤：缺少 job_id 參數。"; return; }

      const me = await fetchJSON("/me"); if (!me) return;
      document.getElementById("who").textContent = `${me.role==='client'?'委託人':'承包人'} · ${me.username}`;

      // 智慧返回按鈕
      const backContainer = document.getElementById("backLinkContainer");
      if (me.role === "client") {
        backContainer.innerHTML = `<a class="btn btn-secondary" href="/clientJobs.html">回我的案件</a>`;
      } else {
        backContainer.innerHTML = `<a class="btn btn-secondary" href="/contractorMyJobs.html">回我的報價/案件</a>`;
      }

      const data = await fetchJSON(`/job/${jobId}/detail`); if (!data) return;

      const job = data.job;
      const bids = data.bids || [];
      const winningBid = data.winning_bid;
      const resultFiles = data.result_files || [];
      const myBid = data.my_bid || null;
      const isInvited = data.is_invited || false;
      const roleRaw = data.user_job_role;
      const role = roleRaw === "visitor_contractor" ? "visitor" : roleRaw;
      const isContractorLike = (roleRaw === "contractor" || roleRaw === "visitor_contractor");

      // 填入基本資訊
      document.getElementById("jobTitle").textContent = job.title;
      document.getElementById("info-id").textContent = job.id;
      document.getElementById("info-status").innerHTML = getStatusBadge(job.status);
      document.getElementById("info-client").textContent = `${escapeHTML(job.client_name)} (#${job.client_id})`;
      document.getElementById("info-content").textContent = job.content;
      document.getElementById("info-budget").innerHTML = job.budget == null ? '<span class="text-muted">未公開</span>' : `<span style="font-weight:600;">${fmtMoney(job.budget)}</span>`;
      document.getElementById("info-due-date").textContent = job.due_date ? fmtDate(job.due_date) : "—";

      function getLatestResultFile(resultFiles) {
        if (!Array.isArray(resultFiles) || resultFiles.length === 0) return null;
        // 你後端是 ORDER BY version ASC，所以最後一筆就是最新
        return resultFiles[resultFiles.length - 1];
      }
      const latestResult = getLatestResultFile(resultFiles);


      // 顯示評價摘要
      const clientRatingBox = document.getElementById("client-rating-summary");
      if (clientRatingBox) {
        if (isContractorLike) {
          clientRatingBox.style.display = "block";
          await renderUserRatingSummary(job.client_id, "client", clientRatingBox);
        }
      }

      // 狀態提示 Alert
      const alertBox = document.getElementById("status-alert-panel");
      if (job.status === 'rejected' && data.last_rejection) {
        alertBox.innerHTML = `<div class="status-alert alert-danger"><b>⚠ 案件被退件</b><div>理由：${escapeHTML(data.last_rejection.message)}</div></div>`;
        alertBox.style.display = 'block';
      } else if (job.status === 'closed') {
        alertBox.innerHTML = `<div class="status-alert alert-success"><b>✓ 案件已結案</b><div>結案時間：${fmtDateTime(job.updated_at)}</div></div>`;
        alertBox.style.display = 'block';
      } else if (job.status === 'invited') {
        alertBox.innerHTML = `<div class="status-alert alert-info"><b>案件邀請中</b><div>等待 ${escapeHTML(job.contractor_name)} 回應。</div></div>`;
        alertBox.style.display = 'block';
      }

      // --- 委託人邏輯 ---
      if (role === 'client') {
        document.getElementById("client-panel").style.display = 'block';
        
        // 報價列表
        const tbody = document.querySelector("#bidsTable tbody");
        if (bids.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-muted" style="text-align:center; padding:20px;">目前尚無任何報價</td></tr>`;
        } else {
          bids.forEach(b => {
            const tr = document.createElement("tr");
            const proposalBtn = b.proposal_file
              ? `<a class="btn btn-secondary btn-sm"
                    href="/uploads/${encodeURIComponent(b.proposal_file)}"
                    download="${escapeHTML(b.proposal_original_name || "proposal.pdf")}">下載 PDF</a>`
              : '<span class="text-muted">—</span>';

            
            tr.innerHTML = `
              <td>
                <div style="font-weight:600;">${escapeHTML(b.contractor_name)}</div>
                <button class="btn btn-secondary btn-sm" style="font-size:12px; padding:2px 8px; margin-top:4px;" type="button" data-show-rating="${b.contractor_id}">★ 查看評價</button>
                <div id="rating-box-${b.contractor_id}" style="margin-top:8px; display:none; border:1px solid #eee; padding:8px; background:#fff; border-radius:6px;"></div>
              </td>
              <td style="font-weight:600;">${fmtMoney(b.price)}</td>
              <td style="max-width:200px; white-space:pre-wrap; font-size:13px;">${escapeHTML(b.note||"")}</td>
              <td>${proposalBtn}</td>
              <td>
                <form action="/bid/accept" method="POST" onsubmit="return confirm('確定選擇此報價？選標後無法更改。')">
                  <input type="hidden" name="job_id" value="${job.id}" />
                  <input type="hidden" name="bid_id" value="${b.id}" />
                  <button class="btn btn-primary btn-sm" type="submit">選擇此人</button>
                </form>
              </td>
            `;
            tbody.appendChild(tr);
          });

          // ✅ 綁定評價展開按鈕（含 cache：避免每次都重抓 API）
          document.querySelectorAll("[data-show-rating]").forEach(btn => {
            btn.addEventListener("click", async () => {
              const uid = btn.getAttribute("data-show-rating");
              const box = document.getElementById(`rating-box-${uid}`);
              if (!box) return;

              // 已載入過：只切換顯示/隱藏
              if (box.dataset.loaded === "1") {
                const isOpen = btn.dataset.open === "1";
                if (isOpen) {
                  box.style.display = "none";
                  btn.dataset.open = "0";
                  btn.textContent = "★ 查看評價";
                } else {
                  box.style.display = "block";
                  btn.dataset.open = "1";
                  btn.textContent = "▲ 收合評價";
                }
                return;
              }

              // 第一次載入
              box.dataset.loaded = "1";
              box.style.display = "block";
              btn.dataset.open = "1";
              btn.textContent = "載入中...";

              await renderUserRatingSummary(uid, "contractor", box);

              btn.textContent = "▲ 收合評價";
            });
          });

        }

        // 審核區塊
        if (job.status === 'uploaded') {
          document.getElementById('client-review-panel').style.display = 'block';
          document.getElementById('review-job-id').value = job.id;

          const link = document.getElementById("download-link");

          if (latestResult) {
            link.href = `/uploads/${encodeURIComponent(latestResult.file_path)}`;
            link.setAttribute("download", latestResult.original_name || "download");
          } else if (job.report_file) {
            // 保底：避免你資料表還沒搬完時整個不能下載
            link.href = `/uploads/${encodeURIComponent(job.report_file)}`;
            link.setAttribute("download", job.report_file);
          } else {
            link.removeAttribute("href");
            link.classList.add("disabled");
            link.textContent = "尚無可下載檔案";
          }

        }

        // 定案區塊
        if (job.status !== 'pending' && job.contractor_id) {
          document.getElementById('client-accepted-panel').style.display = 'block';
          document.getElementById('win-contractor').textContent = escapeHTML(job.contractor_name);
          if (winningBid) {
            document.getElementById('win-price').textContent = fmtMoney(winningBid.price);
            document.getElementById('win-note').textContent = winningBid.note || "(無)";
            // ★★★ 修正點 1：將連結改為灰色按鈕 ★★★
            document.getElementById("win-proposal").innerHTML =
              winningBid.proposal_file
                ? `<a class="btn btn-secondary btn-sm"
                      href="/uploads/${encodeURIComponent(winningBid.proposal_file)}"
                      download="${escapeHTML(winningBid.proposal_original_name || "proposal.pdf")}">下載提案</a>`
                : "(無)";

          } else {
            document.getElementById('win-price').textContent = fmtMoney(job.budget);
            document.getElementById('win-note').textContent = "(邀請制)";
          }
        }
      }

      // --- 承包人邏輯 ---
      if (isContractorLike) {
        document.getElementById("contractor-panel").style.display = 'block';

        if (job.status === 'invited' && isInvited) {
          document.getElementById('contractor-invite-panel').style.display = 'block';
          document.getElementById('invite-client-name').textContent = escapeHTML(job.client_name);
          document.getElementById('invite-price').textContent = fmtMoney(job.budget);
          document.getElementById('invite-job-id-acc').value = job.id;
          document.getElementById('invite-job-id-dec').value = job.id;
        }

        if (job.status !== 'pending' && job.contractor_id === me.user_id) {
          if (winningBid) {
            document.getElementById('contractor-win-panel').style.display = 'block';
            document.getElementById('my-win-price').textContent = fmtMoney(winningBid.price);
            document.getElementById('my-win-note').textContent = winningBid.note || "(無)";
            // ★★★ 修正點 2：將連結改為灰色按鈕 ★★★
            document.getElementById("my-win-proposal").innerHTML =
              winningBid.proposal_file
                ? `<a class="btn btn-secondary btn-sm"
                      href="/uploads/${encodeURIComponent(winningBid.proposal_file)}"
                      download="${escapeHTML(winningBid.proposal_original_name || "proposal.pdf")}">下載提案</a>`
                : "(無)";

          } else {
            document.getElementById('contractor-invite-win-panel').style.display = 'block';
            document.getElementById('my-invite-win-price').textContent = fmtMoney(job.budget);
          }

          // 上傳區塊
          if (job.status === 'accepted' || job.status === 'rejected') {
            document.getElementById('contractor-upload-panel').style.display = 'block';
            document.getElementById('upload-job-id').value = job.id;
          } else if (job.status === 'uploaded' || job.status === 'closed') {
            document.getElementById('contractor-review-panel').style.display = 'block';

            const link = document.getElementById("contractor-download-link");

            if (latestResult) {
              link.href = `/uploads/${encodeURIComponent(latestResult.file_path)}`;
              link.setAttribute("download", latestResult.original_name || "download");
            } else if (job.report_file) {
              link.href = `/uploads/${encodeURIComponent(job.report_file)}`;
              link.setAttribute("download", job.report_file);
            } else {
              link.removeAttribute("href");
              link.classList.add("disabled");
              link.textContent = "尚無可下載檔案";
            }

          }
        }
      }

      // --- 訪客邏輯 ---
      if (role === 'visitor') {
        const visitorPanel = document.getElementById("visitor-panel");
        visitorPanel.style.display = 'block';
        if (job.status === 'pending') {
          if (myBid) {
            // ★★★ 修正點 3：將連結改為灰色按鈕，並微調排版 ★★★
            let proposalPart = '';
            if (myBid.proposal_file) {
              proposalPart = `<div style="margin-top:10px;">您的提案書：<a class="btn btn-secondary btn-sm" href="/uploads/${encodeURIComponent(myBid.proposal_file)}" download="${escapeHTML(myBid.proposal_original_name || 'proposal.pdf')}">下載</a></div>`;
            }
            visitorPanel.innerHTML = `<h2>您已報價</h2><p>您的報價：<b>${fmtMoney(myBid.price)}</b></p><p>請靜待委託人選標。</p>${proposalPart}`;
          } else {
            visitorPanel.innerHTML = `<h2>此案件開放報價中</h2><p>您可以前往報價頁面提出提案。</p><a class="btn btn-primary" href="/bidForm.html?job_id=${job.id}&title=${encodeURIComponent(job.title)}">我要出價</a>`;
          }
        } else {
          visitorPanel.innerHTML = `<h2>案件處理中</h2><p>此案件目前未開放報價。</p>`;
        }
      }

      // 歷史版本
      if (resultFiles.length > 0) {
        const rhp = document.getElementById('result-history-panel');
        rhp.style.display = 'block';
        let html = `<h2>結案檔案歷史版本</h2><table class="table"><thead><tr><th>版本</th><th>上傳時間</th><th>下載</th></tr></thead><tbody>`;
        resultFiles.forEach((f, i) => {
          html += `<tr><td>v${i+1}</td><td>${fmtDateTime(f.uploaded_at)}</td><td><a class="btn btn-secondary btn-sm"
            href="/uploads/${encodeURIComponent(f.file_path)}"
            download="${escapeHTML(f.original_name || ("result_v"+(i+1)+".pdf"))}">下載</a>
          </td></tr>`;
        });
        html += `</tbody></table>`;
        rhp.innerHTML = html;
      }
    }

    loadPage();
    initExtensionPanels(); 

    window.addEventListener('pageshow', function (e) {
      if (e.persisted) location.reload();
    });
  </script>
</body>
</html>