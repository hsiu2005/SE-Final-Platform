<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>案件詳情</title>
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; --head:#f3f4f6; }
    body {
      font-family: system-ui, -apple-system, "Microsoft JhengHei", Arial, sans-serif;
      padding: 16px;
      max-width: 900px;
      margin: auto;
      background-color: #fff7e5;
    }
    h1 { margin: 0 0 12px; }
    h2 {
      margin: 24px 0 12px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }
    .toolbar {
      margin: 8px 0 16px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    table { border-collapse: collapse; width: 100%; }
    th, td {
      border: 1px solid var(--border);
      padding: 10px 8px;
      vertical-align: top;
    }
    th {
      background: var(--head);
      text-align: left;
      width: 120px;
    }
    tr:hover { background: #fafafa; }
    .btn {
      display: inline-block;
      padding: 6px 10px;
      border: 1px solid #aaa;
      border-radius: 6px;
      text-decoration: none;
      color: #222;
      background:#fff;
      cursor: pointer;
      font-size:14px;
    }
    .btn:hover { background: #f5f5f5; }
    .btn.primary { background:#007bff; color:#fff; border-color:#007bff; }
    .btn.success { background:#28a745; color:#fff; border-color:#28a745; }
    .btn.danger  { background:#dc3545; color:#fff; border-color:#dc3545; }
    .btn[disabled] {
      background: #ccc;
      border-color: #ccc;
      color: #666;
      cursor: not-allowed;
    }
    .muted { color: var(--muted); }
    #error { color: #b30000; margin: 8px 0; font-weight: bold; }
    .note { white-space: pre-wrap; word-break: break-word; }
    .job-info-table th { width: 100px; }
    .job-info-table td { white-space: pre-wrap; word-break: break-word; }
    .bids-table th:first-child { width: 120px; }
    .panel {
      background: #f9f9f9;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    .panel-title {
      font-weight: bold;
      font-size: 1.1em;
      margin: 0 0 12px;
    }
    textarea {
      width: 98%;
      padding: 8px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    input[type=file] { margin-bottom: 10px; }
    .status-alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .alert-success { background-color: #d4edda; border:1px solid #c3e6cb; color: #155724; }
    .alert-danger  { background-color: #f8d7da; border:1px solid #f5c6cb; color: #721c24; }
    .alert-info    { background-color: #d1ecf1; border:1px solid #bee5eb; color: #0c5460; }

    /* 狀態膠囊 badge */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
      line-height: 1.2;
    }
    .badge-yellow {
      background-color: #fff3c7;
      color: #7a6b1f;
    }
    .status-badge {
      min-width: 72px;
      justify-content: center;
      text-align: center;
    }

    .stars {
      position: relative;
      display: inline-block;
      font-size: 16px;
      line-height: 1;
      letter-spacing: 2px;
    }
    .stars::before {
      content: "★★★★★";
      color: #d1d5db;
    }
    .stars::after {
      content: "★★★★★";
      color: #f5c518;
      position: absolute;
      left: 0;
      top: 0;
      width: var(--pct, 0%);
      overflow: hidden;
    }

  </style>
</head>
<body>
  <span id="who" class="muted"></span>
  <h1>案件詳情：<span id="jobTitle"></span></h1>
  <div class="toolbar">
    <a class="btn" href="/">← 回我的案件列表</a>
    <a class="btn" href="/logout">登出</a>
  </div>

  <div id="error"></div>
  <div id="status-alert-panel" style="display:none;"></div>

  <h2>案件資訊</h2>
  <table class="job-info-table">
    <tr><th>ID</th><td id="info-id"></td></tr>
    <tr><th>狀態</th><td id="info-status"></td></tr>
    <tr><th>委託人</th><td id="info-client"></td></tr>
    <tr><th>內容</th><td id="info-content"></td></tr>
    <tr><th>預算</th><td id="info-budget"></td></tr>
    <tr><th>截止日</th><td id="info-due-date"></td></tr>
  </table>

  <div id="client-rating-summary" class="panel" style="display:none;"></div>

  <!-- 委託人區塊 -->
  <div id="client-panel" style="display:none;">
    <div id="client-bids-panel">
      <h2>報價列表</h2>
      <table id="bidsTable" class="bids-table">
        <thead>
          <tr>
            <th>承包人</th>
            <th>報價金額</th>
            <th>留言 (note)</th>
            <th>提案書</th>
            <th>動作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="client-review-panel" class="panel" style="display:none;">
      <div class="panel-title">審核承包人上傳的成果</div>
      <p>承包人已上傳檔案，請下載審核：</p>
      <p><a id="download-link" href="#" class="btn primary" download>下載結案檔案</a></p>
      <hr>
      <form action="/job/review" method="POST">
        <input type="hidden" name="job_id" id="review-job-id">
        <p>審核結果：</p>
        <textarea name="message" rows="3" placeholder="若選擇退件，請在此說明理由..."></textarea>
        <br><br>
        <button class="btn primary" type="submit" name="decision" value="closed">驗收結案 (Closed)</button>
        <button class="btn danger" type="submit" name="decision" value="rejected">退件 (Rejected)</button>
      </form>
    </div>

    <div id="client-accepted-panel" class="panel" style="display:none;">
      <div class="panel-title">最終承接人資訊</div>
      <table class="job-info-table">
        <tr id="win-contractor-row"><th>承接廠商</th><td id="win-contractor"></td></tr>
        <tr id="win-price-row"><th>承接金額</th><td id="win-price"></td></tr>
        <tr id="win-note-row"><th>廠商備註</th><td id="win-note"></td></tr>
        <tr id="win-proposal-row"><th>提案書</th><td id="win-proposal"></td></tr>
      </table>
    </div>
  </div>

  <!-- 承包人區塊 -->
  <div id="contractor-panel" style="display:none;">
    <div id="contractor-invite-panel" class="panel" style="display:none;">
      <div class="panel-title">您收到了此案件的邀請</div>
      <p>委託人 <b id="invite-client-name"></b> 邀請您承接此案件。</p>
      <p><b>承接預算：<span id="invite-price" style="font-weight:bold; color:#007bff;"></span></b></p>
      <p>
        <form action="/invitation/accept" method="POST" style="display:inline-block; margin-right: 10px;">
          <input type="hidden" name="job_id" id="invite-job-id-acc" />
          <button class="btn success" type="submit">接受邀請</button>
        </form>
        <form action="/invitation/decline" method="POST" style="display:inline-block;" onsubmit="return confirm('確定要婉拒嗎？婉拒後案件將轉為公開，您仍可稍後報價。')">
          <input type="hidden" name="job_id" id="invite-job-id-dec" />
          <button class="btn danger" type="submit">婉拒邀請</button>
        </form>
      </p>
    </div>

    <div id="contractor-win-panel" class="panel" style="display:none;">
      <div class="panel-title">您的得標資訊 (報價制)</div>
      <table class="job-info-table">
        <tr><th>您的報價</th><td id="my-win-price"></td></tr>
        <tr><th>您的備註</th><td id="my-win-note"></td></tr>
        <tr><th>提案書</th><td id="my-win-proposal"></td></tr>
      </table>
    </div>

    <div id="contractor-invite-win-panel" class="panel" style="display:none;">
      <div class="panel-title">您的承接資訊 (邀請制)</div>
      <table class="job-info-table">
        <tr><th>承接預算</th><td id="my-invite-win-price"></td></tr>
      </table>
    </div>

    <div id="contractor-upload-panel" class="panel" style="display:none;">
      <div class="panel-title">上傳結案檔案</div>
      <p>恭喜您承接此案件！請在此上傳您的結案報告或檔案。</p>
      <form action="/job/upload" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="job_id" id="upload-job-id">
        <input type="file" name="report_file" required>
        <br>
        <button class="btn primary" type="submit">上傳檔案</button>
      </form>
    </div>

    <div id="contractor-review-panel" class="panel" style="display:none;">
      <div class="panel-title">等待委託人驗收</div>
      <p>您已上傳檔案，請靜待委託人審核。</p>
      <p><a id="contractor-download-link" href="#" class="btn" download>下載您上傳的檔案</a></p>
    </div>
  </div>

  <div id="visitor-panel" class="panel" style="display:none;"></div>

  <!-- 歷史版本區塊 -->
  <div id="result-history-panel" class="panel" style="display:none;"></div>

  <!-- Issue 與 評價區塊 -->
  <div id="issue-panel" class="panel" style="display:none;"></div>
  <div id="rating-panel" class="panel" style="display:none;"></div>

  <script>
    // ----------------------------
    // 小工具
    // ----------------------------
    function starsHTML(avg) {
      const v = Math.max(0, Math.min(5, Number(avg || 0)));
      const pct = (v / 5) * 100;
      return `<span class="stars" style="--pct:${pct}%;"></span>`;
    }

    async function fetchJSON(url, options={}) {
      const resp = await fetch(url, options);
      if (resp.status === 401) { window.location.href="/loginForm.html"; return null; }
      if (resp.redirected) { window.location.href = resp.url; return null; }
      if (!resp.ok) {
        const errText = await resp.text();
        document.getElementById("error").textContent = `API 錯誤 ${resp.status}: ${errText}`;
        return null;
      }
      return await resp.json();
    }

    const escapeHTML = s => s==null ? "" : String(s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

    const currency = new Intl.NumberFormat("zh-Hant-TW", { style:"currency", currency:"TWD", maximumFractionDigits:0 });
    const fmtMoney = n => (n==null ? "N/A" : currency.format(Number(n)));
    const fmtDate = s => s ? new Date(s).toLocaleDateString("zh-Hant-TW") : "";
    const fmtDateTime = s => s ? new Date(s).toLocaleString("zh-Hant-TW") : "";

    const params = new URLSearchParams(location.search);
    const jobId = params.get("job_id");

    // DOM
    const jobTitleEl = document.getElementById("jobTitle");
    const errorEl = document.getElementById("error");
    const whoEl = document.getElementById("who");
    const infoId = document.getElementById("info-id");
    const infoStatus = document.getElementById("info-status");
    const infoClient = document.getElementById("info-client");
    const infoContent = document.getElementById("info-content");
    const infoBudget = document.getElementById("info-budget");
    const infoDueDate = document.getElementById("info-due-date");

    const clientPanel = document.getElementById("client-panel");
    const clientBidsPanel = document.getElementById("client-bids-panel");
    const clientReviewPanel = document.getElementById("client-review-panel");
    const clientAcceptedPanel = document.getElementById("client-accepted-panel");

    const contractorPanel = document.getElementById("contractor-panel");
    const contractorUploadPanel = document.getElementById("contractor-upload-panel");
    const contractorReviewPanel = document.getElementById("contractor-review-panel");
    const contractorWinPanel = document.getElementById("contractor-win-panel");
    const contractorInvitePanel = document.getElementById("contractor-invite-panel");
    const contractorInviteWinPanel = document.getElementById("contractor-invite-win-panel");

    const visitorPanel = document.getElementById("visitor-panel");
    const statusAlertPanel = document.getElementById("status-alert-panel");
    const resultHistoryPanel = document.getElementById("result-history-panel");

    const issuePanel = document.getElementById("issue-panel");
    const ratingPanel = document.getElementById("rating-panel");

    // 評價維度：依「被評對象」不同而不同（符合投影片）
    const RATING_DIM_LABELS_BY_TARGET = {
      client: ["需求合理性", "驗收難度", "合作態度"],
      contractor: ["產出品質", "執行效率", "合作態度"]
    };

    function renderStatusBadge(status) {
      const s = escapeHTML(status || "");
      return `<span class="badge badge-yellow status-badge">${s}</span>`;
    }

    // 顯示後端 redirect 帶回來的訊息（toast=...）
    (function showToastFromQuery(){
      const p = new URLSearchParams(location.search);
      const toast = p.get("toast");
      if (!toast) return;

      const box = document.getElementById("status-alert-panel");
      if (box) {
        box.innerHTML = `<div class="status-alert alert-info"><b>提示：</b>${escapeHTML(toast)}</div>`;
        box.style.display = "block";
      }

      p.delete("toast");
      history.replaceState(null, "", location.pathname + "?" + p.toString());
    })();

    // ✅ 共用：渲染某個使用者的評價摘要（client / contractor）
    async function renderUserRatingSummary(targetUserId, asTargetRole, mountEl) {
      const resp = await fetch(`/user/${targetUserId}/rating-summary?as_target_role=${asTargetRole}`, {
        credentials: "include"
      });

      if (!resp.ok) {
        const errText = await resp.text().catch(() => "");
        console.log("[rating-summary] status=", resp.status, "body=", errText);
        mountEl.innerHTML = `
          <div class="panel-title">過往評價</div>
          <p class="muted">（暫時無法取得評價摘要）</p>
          <p class="muted">HTTP ${resp.status}</p>
          <pre style="white-space:pre-wrap;word-break:break-word;background:#fff;border:1px solid #e5e7eb;padding:8px;border-radius:8px;">${escapeHTML(errText)}</pre>
        `;
        return;
      }


      const json = await resp.json();
      if (!json.success) {
        mountEl.innerHTML = `<div class="panel-title">過往評價</div><p class="muted">（目前沒有評價資料）</p>`;
        return;
      }

      const d = json.data || {};
      const allComments = (d.recent_comments || []);
      const comments = allComments.slice(0, 3);

      const labels = RATING_DIM_LABELS_BY_TARGET[asTargetRole] || ["維度1","維度2","維度3"];

      mountEl.innerHTML = `
        <div class="panel-title">過往評價（${asTargetRole === "client" ? "委託人" : "承包人"}）</div>

        <div>
          平均總分：
          ${starsHTML(d.avg_overall)}
          <b style="margin-left:6px;">${Number(d.avg_overall || 0).toFixed(1)}</b>
          <span class="muted">（共 ${d.count || 0} 筆）</span>
        </div>

        <div class="muted" style="margin-top:6px;">
          ${labels[0]}：${Number(d.avg_dim1 || 0).toFixed(1)}　
          ${labels[1]}：${Number(d.avg_dim2 || 0).toFixed(1)}　
          ${labels[2]}：${Number(d.avg_dim3 || 0).toFixed(1)}
        </div>

        <div style="margin-top:10px;">
          <b>近期質性意見：</b>
          ${comments.length === 0
            ? `<div class="muted">（沒有留言）</div>`
            : comments.map(c => `
                <div style="border:1px solid #e5e7eb;border-radius:6px;padding:8px;margin-top:6px;background:#fff;">
                  <div style="display:flex;justify-content:space-between;gap:10px;">
                    <b>${escapeHTML(c.from_name || "匿名")}</b>
                    <small class="muted">${c.created_at ? fmtDateTime(c.created_at) : ""}</small>
                  </div>
                  <div style="margin-top:6px;">${escapeHTML(c.comment || "")}</div>
                </div>
              `).join("")
          }
        </div>

        <div style="margin-top:10px;">
          <button class="btn" type="button" id="openAllCommentsBtn">
            查看全部留言（最多 10 筆）
          </button>
        </div>
      `;

      // ✅ 綁定「查看全部留言」按鈕事件（先用 alert 驗證資料）
      const btn = mountEl.querySelector("#openAllCommentsBtn");
      if (btn) {
        btn.addEventListener("click", () => {
          if (!allComments || allComments.length === 0) {
            alert("沒有留言");
            return;
          }

          // 如果你已經做了 openRatingModal()，就用 modal
          if (typeof openRatingModal === "function") {
            openRatingModal(
              `全部留言（${asTargetRole === "client" ? "委託人" : "承包人"}）`,
              allComments
            );
            return;
          }

          // 否則先用 alert 顯示（讓你先確認 from_name 有回來）
          const text = allComments.map((c, i) => {
            const name = c.from_name || "匿名";
            const time = c.created_at ? fmtDateTime(c.created_at) : "";
            const msg = c.comment || "";
            return `#${i+1} ${name} ${time}\n${msg}`;
          }).join("\n\n----------------\n\n");

          alert(text);
        });
      }
    }




    // ----------------------------
    // 主頁內容
    // ----------------------------
    async function loadPage() {
      if (!jobId) { errorEl.textContent = "錯誤：缺少 job_id 參數。"; return; }

      const me = await fetchJSON("/me"); if (!me) return;
      whoEl.textContent = `登入中：${me.role} ${me.username}`;

      const data = await fetchJSON(`/job/${jobId}/detail`); if (!data) return;

      const job = data.job;
      const bids = data.bids || [];
      //const role = data.user_job_role;
      const lastRejection = data.last_rejection;
      const winningBid = data.winning_bid;
      const resultFiles = data.result_files || [];
      const myBid = data.my_bid || null;
      const isInvited = data.is_invited || false;
      const roleRaw = data.user_job_role;
      const role = roleRaw === "visitor_contractor" ? "visitor" : roleRaw;

// 若你需要知道「這個人其實是承包人身分」
const isContractorLike = (roleRaw === "contractor" || roleRaw === "visitor_contractor");


      jobTitleEl.textContent = job.title;
      infoId.textContent = job.id;
      infoStatus.innerHTML = renderStatusBadge(job.status);
      infoClient.textContent = `${escapeHTML(job.client_name)} (#${job.client_id})`;
      // ✅ 乙方/訪客看需求：顯示甲方（委託人）過往評價
      const clientRatingBox = document.getElementById("client-rating-summary");
      /*
      if (clientRatingBox) {
        if (role === "contractor" || role === "visitor") {
          clientRatingBox.style.display = "block";
          await renderUserRatingSummary(job.client_id, "client", clientRatingBox);
        } else {
          clientRatingBox.style.display = "none";
        }
      }
      */

      if (clientRatingBox) {
        if (isContractorLike) {
          clientRatingBox.style.display = "block";
          await renderUserRatingSummary(job.client_id, "client", clientRatingBox);
        } else {
          clientRatingBox.style.display = "none";
        }
      }

      infoContent.textContent = job.content;
      infoBudget.textContent = job.budget == null ? "—" : fmtMoney(job.budget);
      infoDueDate.textContent = job.due_date ? fmtDate(job.due_date) : "—";

      // 狀態提示
      if (job.status === 'rejected' && lastRejection) {
        statusAlertPanel.innerHTML = `<div class="status-alert alert-danger"><b>案件被退件：</b>委託人已退回您上傳的成果，請重新上傳。<br><b>理由：</b>${escapeHTML(lastRejection.message)}</div>`;
        statusAlertPanel.style.display = 'block';
      }
      else if (job.status === 'closed') {
        statusAlertPanel.innerHTML = `<div class="status-alert alert-success"><b>案件已結案：</b>此案件已於 ${fmtDateTime(job.updated_at)} 驗收結案。</div>`;
        statusAlertPanel.style.display = 'block';
      }
      else if (job.status === 'invited') {
        statusAlertPanel.innerHTML = `<div class="status-alert alert-info"><b>案件邀請中：</b>此案件正等待 ${escapeHTML(job.contractor_name)} 回應邀請。</div>`;
        statusAlertPanel.style.display = 'block';
      }

      // ---- 委託人視角 ----
      if (role === 'client') {
        clientPanel.style.display = 'block';

        const tbody = document.querySelector("#bidsTable tbody");
        tbody.innerHTML = "";
        if (bids.length === 0) {
          clientBidsPanel.innerHTML = `<h2>報價列表</h2><p class="muted">目前尚無任何報價。</p>`;
        } else {
          bids.forEach(b => {
            console.log("bid object:", b);
            const tr = document.createElement("tr");
            const proposalCell = b.proposal_file
              ? `<a class="btn" href="/uploads/${encodeURIComponent(b.proposal_file)}" download="${escapeHTML(b.proposal_original_name || "proposal.pdf")}">下載</a>`
              : `<span class="muted">(無)</span>`;
            tr.innerHTML = `
              <td>
                <div><b>${escapeHTML(b.contractor_name)}</b></div>
                <button class="btn" type="button" data-show-rating="${b.contractor_id}" data-open="0">
                  ★ 查看評價
                </button>

                <div id="rating-box-${b.contractor_id}" style="margin-top:8px; display:none;"></div>
              </td>
              <td>${fmtMoney(b.price)}</td>
              <td class="note">${escapeHTML(b.note || "")}</td>
              <td>${proposalCell}</td>
              <td>
                <form action="/bid/accept" method="POST" onsubmit="return confirm('確定選擇此報價？選標後無法更改。')">
                  <input type="hidden" name="job_id" value="${job.id}" />
                  <input type="hidden" name="bid_id" value="${b.id}" />
                  <button class="btn primary" type="submit">選擇此報價</button>
                </form>
              </td>
            `;
            tbody.appendChild(tr);
          });
          // ✅ 甲方看提案：點按鈕才載入乙方（承包人）評價摘要
          document.querySelectorAll("[data-show-rating]").forEach(btn => {
            btn.addEventListener("click", async () => {
              const uid = btn.getAttribute("data-show-rating");
              const box = document.getElementById(`rating-box-${uid}`);
              if (!box) return;

              // 已載入過：切換顯示/隱藏 + 按鈕文字切換
              if (box.dataset.loaded === "1") {
                const isOpen = btn.dataset.open === "1";
                if (isOpen) {
                  box.style.display = "none";
                  btn.dataset.open = "0";
                  btn.innerHTML = "★ 查看評價";
                } else {
                  box.style.display = "block";
                  btn.dataset.open = "1";
                  btn.innerHTML = "★ 收合評價";
                }
                return;
              }

              box.dataset.loaded = "1";
              box.style.display = "block";
              box.innerHTML = `<p class="muted">載入中...</p>`;
              await renderUserRatingSummary(uid, "contractor", box);
              btn.dataset.open = "1";
              btn.innerHTML = "★ 收合評價";
            });
          });

        }

        if (job.status === 'uploaded') {
          clientReviewPanel.style.display = 'block';
          document.getElementById('review-job-id').value = job.id;
          document.getElementById('download-link').href = `/uploads/${encodeURIComponent(job.report_file)}`;
        }

        if (job.status !== 'pending' && job.contractor_id) {
          clientAcceptedPanel.style.display = 'block';
          document.getElementById('win-contractor').textContent = escapeHTML(job.contractor_name);

          if (winningBid) {
            document.getElementById('win-price-row').querySelector('th').textContent = "得標金額";
            document.getElementById('win-note-row').querySelector('th').textContent = "廠商備註";
            document.getElementById('win-price').textContent = fmtMoney(winningBid.price);
            document.getElementById('win-note').innerHTML = winningBid.note ? escapeHTML(winningBid.note) : '<span class="muted">(無)</span>';
            if (winningBid.proposal_file) {
              document.getElementById('win-proposal').innerHTML = `<a class="btn" href="/uploads/${encodeURIComponent(winningBid.proposal_file)}" download="${escapeHTML(winningBid.proposal_original_name || "proposal.pdf")}">下載</a>`;
            } else {
              document.getElementById('win-proposal').innerHTML = '<span class="muted">(無)</span>';
            }
          } else {
            document.getElementById('win-price-row').querySelector('th').textContent = "預算金額";
            document.getElementById('win-note-row').querySelector('th').textContent = "備註";
            document.getElementById('win-price').textContent = fmtMoney(job.budget);
            document.getElementById('win-note').innerHTML = '<span class="muted">(邀請制案件)</span>';
            document.getElementById('win-proposal').innerHTML = '<span class="muted">(無提案書)</span>';
          }
        }
      }

      // ---- 承包人視角 ----
      if (isContractorLike) {
          contractorPanel.style.display = 'block';

        if (job.status === 'invited' && isInvited) {
          contractorInvitePanel.style.display = 'block';
          document.getElementById('invite-client-name').textContent = escapeHTML(job.client_name);
          document.getElementById('invite-price').textContent = fmtMoney(job.budget);
          document.getElementById('invite-job-id-acc').value = job.id;
          document.getElementById('invite-job-id-dec').value = job.id;
        }

        if (job.status !== 'pending' && job.contractor_id === me.user_id && winningBid) {
          contractorWinPanel.style.display = 'block';
          document.getElementById('my-win-price').textContent = fmtMoney(winningBid.price);
          document.getElementById('my-win-note').innerHTML = winningBid.note ? escapeHTML(winningBid.note) : '<span class="muted">(無)</span>';
          if (winningBid.proposal_file) {
            document.getElementById('my-win-proposal').innerHTML = `<a class="btn" href="/uploads/${encodeURIComponent(winningBid.proposal_file)}" download="${escapeHTML(winningBid.proposal_original_name || "proposal.pdf")}">下載</a>`;
          } else {
            document.getElementById('my-win-proposal').innerHTML = '<span class="muted">(無提案書)</span>';
          }
        }

        if (job.status !== 'pending' && job.contractor_id === me.user_id && !winningBid) {
          contractorInviteWinPanel.style.display = 'block';
          document.getElementById('my-invite-win-price').textContent = fmtMoney(job.budget);
        }

        if (job.contractor_id === me.user_id) {
          if (job.status === 'accepted' || job.status === 'rejected') {
            contractorUploadPanel.style.display = 'block';
            document.getElementById('upload-job-id').value = job.id;
          } else if (job.status === 'uploaded' || job.status === 'closed') {
            contractorReviewPanel.style.display = 'block';
            document.getElementById('contractor-download-link').href = `/uploads/${encodeURIComponent(job.report_file)}`;
          }
        }
      }

      // ---- 訪客視角 ----
      if (role === 'visitor') {
        visitorPanel.style.display = 'block';

        if (job.status === 'pending') {
          if (myBid) {
            let proposalPart = '';
            if (myBid.proposal_file) {
              proposalPart = `<p>您的提案書：<a class="btn" href="/uploads/${encodeURIComponent(myBid.proposal_file)}" download="${escapeHTML(myBid.proposal_original_name || 'proposal.pdf')}">下載</a></p>`;
            }
            visitorPanel.innerHTML = `
              <div class="panel-title">您已報價</div>
              <p>您對此案件的報價為：<b>${fmtMoney(myBid.price)}</b></p>
              <p>請靜待委託人選標。</p>
              ${proposalPart}
            `;
          } else {
            visitorPanel.innerHTML = `
              <div class="panel-title">此案件開放報價中</div>
              <p>若您有興趣接案，可以前往報價頁面提出您的報價與提案書。</p>
              <p><a class="btn primary" href="/bidForm.html?job_id=${job.id}&title=${encodeURIComponent(job.title)}">我要出價</a></p>`;
          }
        } else {
          visitorPanel.innerHTML = `
            <div class="panel-title">案件處理中</div>
            <p>此案件 (狀態: ${escapeHTML(job.status)}) 目前未開放報價。</p>`;
        }
      }

      // ---- 歷史版本 ----
      if (resultFiles.length > 0) {
        let html = `
          <div class="panel-title">結案檔案歷史版本</div>
          <p class="muted">以下為此案件承包人歷次上傳的成果檔案紀錄（版本 1 為最早上傳）。</p>
          <table class="job-info-table">
            <tr>
              <th>版本</th>
              <th>檔名</th>
              <th>上傳時間</th>
              <th>下載</th>
            </tr>
        `;
        resultFiles.forEach((f, idx) => {
          html += `
            <tr>
              <td>v${idx + 1}</td>
              <td>${escapeHTML(f.original_name || f.file_path)}</td>
              <td>${fmtDateTime(f.uploaded_at)}</td>
              <td><a class="btn" href="/uploads/${encodeURIComponent(f.file_path)}" download="${escapeHTML(f.original_name || 'report.pdf')}">下載</a></td>
            </tr>
          `;
        });
        html += `</table>`;
        resultHistoryPanel.innerHTML = html;
        resultHistoryPanel.style.display = 'block';
      }
    }

    // ----------------------------
    // Issue Panel（只給委託人/得標承包人）
    // ----------------------------
    async function loadIssuesPanel(jobId, role, jobStatus) {
      if (!issuePanel) return;

      issuePanel.innerHTML = "";
      issuePanel.style.display = "block";

      let issues = null;
      try {
        const resp = await fetch(`/job/${jobId}/issues`, { credentials: "include" });

        if (resp.status === 401) {
          window.location.href = "/loginForm.html";
          return;
        }

        if (!resp.ok) {
          issuePanel.innerHTML = `
            <div class="panel-title">Issue Tracker</div>
            <p class="muted">此案件目前無法查看 Issue（可能您不是此案件相關人，或案件尚未進入可使用 Issue 的階段）。</p>
          `;
          return;
        }

        const payload = await resp.json();
        issues = payload?.data?.issues ?? payload?.issues ?? payload ?? [];

      } catch (e) {
        console.error("loadIssuesPanel fetch error:", e);
        issuePanel.innerHTML = `
          <div class="panel-title">Issue Tracker</div>
          <p class="muted">Issue 載入失敗，請稍後再試。</p>
        `;
        return;
      }

      let html = `<div class="panel-title">Issue Tracker</div>`;

      // 委託人：只有 uploaded / rejected 才能建立 issue（避免送出→錯誤頁）
      if (role === "client") {
        const canCreate = (jobStatus === "uploaded" || jobStatus === "rejected");
        if (canCreate) {
          html += `
            <form method="post" action="/job/issue/new" style="margin-bottom:12px;">
              <input type="hidden" name="job_id" value="${jobId}">
              <input name="title" placeholder="Issue 標題"
                    style="width:100%;padding:6px;margin-bottom:4px;" required>
              <textarea name="description" rows="2" placeholder="Issue 描述"
                        style="width:100%;padding:6px;margin-bottom:4px;"></textarea>
              <button class="btn" type="submit">新增 Issue</button>
            </form>
          `;
        } else {
          html += `
            <p class="muted" style="margin-bottom:12px;">
              目前案件狀態為 <b>${escapeHTML(jobStatus || "")}</b>，需承包人上傳成果後才能建立 Issue。
            </p>
          `;
        }
      }

      if (!issues || issues.length === 0) {
        html += `<p class="muted">目前沒有 Issue。</p>`;
        issuePanel.innerHTML = html;
        return;
      }

      issues.forEach(issue => {
        const isClosed = (issue.status === "closed");

        html += `
          <div style="border:1px solid #e5e7eb;border-radius:6px;padding:8px;margin-bottom:8px;background:#fff;">
            <b>[${escapeHTML(issue.status)}] ${escapeHTML(issue.title)}</b><br>
            <span class="muted">${escapeHTML(issue.description || "")}</span><br>
            <small class="muted">建立於：${escapeHTML(issue.created_at)}</small>
        `;

        if (role === "client" && !isClosed) {
          html += `
            <form method="post" action="/job/issue/close" style="margin-top:6px;">
              <input type="hidden" name="issue_id" value="${issue.id}">
              <button class="btn success" type="submit">標記為完成</button>
            </form>
          `;
        }

        if (isClosed) {
          html += `
            <div class="muted" style="margin-top:6px;">
              此 Issue 已關閉${issue.closed_at ? `（關閉於：${escapeHTML(issue.closed_at)}）` : ""}，不可再留言。
            </div>
          `;
        }

        html += `<div style="margin-top:10px;">`;

        (issue.comments || []).forEach(c => {
          html += `
            <div style="border:1px solid #f3f4f6;border-radius:4px;padding:6px 8px;margin-bottom:6px;background:#fcfcfc;">
              <b>User ${escapeHTML(c.author_id)}</b>：${escapeHTML(c.content)}
              <br><small class="muted">${escapeHTML(c.created_at)}</small>
            </div>
          `;
        });

        html += `
          <form method="post" action="/job/issue/comment" style="margin-top:6px;">
            <input type="hidden" name="issue_id" value="${issue.id}">
            <input
              name="content"
              placeholder="${isClosed ? "此 Issue 已關閉，無法新增留言" : "新增留言"}"
              style="width:100%;padding:6px;margin-bottom:6px;"
              ${isClosed ? "disabled" : ""}
              ${isClosed ? "" : "required"}
            >
            <button class="btn" type="submit" ${isClosed ? "disabled" : ""}>送出留言</button>
          </form>
        `;

        html += `</div></div>`;
      });

      issuePanel.innerHTML = html;
    }
    // ✅ 已評價就鎖表單 + 顯示提醒（避免使用者一直想送）
    async function lockRatingFormIfRated(jobId) {
      // 先確認有評價表單
      const form = document.querySelector("#rating-panel form");
      if (!form) return;

      // 先抓我自己是誰
      const meResp = await fetch("/me", { credentials: "include" });
      if (!meResp.ok) return;
      const me = await meResp.json();
      const myId = me.user_id;

      // 再抓此案件所有評價
      const resp = await fetch(`/job/${jobId}/ratings`, { credentials: "include" });
      if (!resp.ok) return;
      const payload = await resp.json();
      const ratings = payload?.data?.ratings ?? payload?.ratings ?? payload ?? [];

      // 判斷「我這次要評的是哪個方向」
      const action = form.getAttribute("action") || "";
      const myTargetRole = action.includes("rate-client") ? "client" : "contractor";

      const alreadyRated = ratings.some(r =>
        Number(r.rater_id) === Number(myId) &&
        r.target_role === myTargetRole
      );

      if (!alreadyRated) return;

      // ✅ 鎖住整個表單
      form.querySelectorAll("input, textarea, button").forEach(el => {
        el.disabled = true;
      });

      // ✅ 顯示提示（用你現成的 status-alert-panel）
      const box = document.getElementById("status-alert-panel");
      if (box) {
        box.innerHTML = `
          <div class="status-alert alert-info">
            <b>已完成評價</b><br>
            你已經送出過評價，評價送出後不可修改。
          </div>
        `;
        box.style.display = "block";
      }

      // ✅ 也可以在評價區塊再補一行小字（更直覺）
      const ratingResult = document.getElementById("rating-result");
      if (ratingResult) {
        ratingResult.insertAdjacentHTML("afterbegin",
          `<p class="muted">（你已送出過評價，表單已鎖定）</p>`
        );
      }
    }


    // ----------------------------
    // Rating Panel（只在 closed）
    // ----------------------------
    function renderRatingPanel(job, role) {
      if (!ratingPanel) return;

      if (job.status !== "closed") {
        ratingPanel.style.display = "none";
        return;
      }

      let action = "";
      let title = "";
      let targetRole = "";

      if (role === "client" && job.contractor_id) {
        action = "/job/rate-contractor";
        targetRole = "contractor";
        title = `評價承包人：${escapeHTML(job.contractor_name || "")}`;
      } else if (role === "contractor") {
        action = "/job/rate-client";
        targetRole = "client";
        title = `評價委託人：${escapeHTML(job.client_name || "")}`;
      } else {
        ratingPanel.style.display = "none";
        return;
      }

      const labels = RATING_DIM_LABELS_BY_TARGET[targetRole] || ["維度1","維度2","維度3"];

      ratingPanel.innerHTML = `
        <div class="panel-title">合作評價</div>
        <p class="muted">${title}</p>

        <!-- ✅ 評價期限提示（新增） -->
        <div id="rating-deadline-hint" class="muted" style="margin:6px 0 10px;"></div>

        <form method="post" action="${action}">
          <input type="hidden" name="job_id" value="${job.id}">

          <label>${labels[0]}（1–5）：</label>
          <input type="number" name="dim1" min="1" max="5" required style="width:100%;padding:6px;margin-bottom:8px;">

          <label>${labels[1]}（1–5）：</label>
          <input type="number" name="dim2" min="1" max="5" required style="width:100%;padding:6px;margin-bottom:8px;">

          <label>${labels[2]}（1–5）：</label>
          <input type="number" name="dim3" min="1" max="5" required style="width:100%;padding:6px;margin-bottom:8px;">

          <label>評論（選填）：</label>
          <textarea name="comment" rows="3" style="width:100%;padding:6px;margin-bottom:10px;"></textarea>

          <button class="btn primary" type="submit">送出評價</button>
        </form>

        <div id="rating-result" style="margin-top:12px;"></div>
      `;


      const form = ratingPanel.querySelector("form");
      if (form) {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const fd = new FormData(form);
          const actionUrl = form.getAttribute("action");

          const resp = await fetch(actionUrl, {
            method: "POST",
            body: fd,
            credentials: "include",
            redirect: "follow",
          });

          // ✅ 已評價：後端回 409
          if (resp.status === 409) {
            const msg = await resp.json().then(x => x.detail).catch(() => "你已經送出過評價（送出後不可修改）");
            // 用你現成的 toast 區塊顯示
            const box = document.getElementById("status-alert-panel");
            box.innerHTML = `<div class="status-alert alert-info"><b>提示：</b>${escapeHTML(msg)}</div>`;
            box.style.display = "block";
            return;
          }

          // ✅ 成功：後端可能回 redirect 到 jobDetail.html?toast=...
          if (resp.redirected) {
            window.location.href = resp.url;
            return;
          }

          // ✅ 逾期或其他規則錯誤：後端通常回 400 且是 JSON {detail:"..." }
          if (resp.status === 400) {
            let msg = "送出失敗";
            try {
              const j = await resp.json();
              msg = j.detail || msg;
            } catch {
              msg = await resp.text().catch(()=> msg);
            }

            const box = document.getElementById("status-alert-panel");
            box.innerHTML = `<div class="status-alert alert-danger"><b>送出失敗：</b>${escapeHTML(msg)}</div>`;
            box.style.display = "block";

            // 如果是逾期，順便把表單鎖起來
            if (String(msg).includes("超過評價期限")) {
              form.querySelectorAll("input, textarea, button").forEach(el => el.disabled = true);
              const hintEl = document.getElementById("rating-deadline-hint");
              if (hintEl && !hintEl.textContent.includes("已逾期")) {
                hintEl.textContent = (hintEl.textContent ? hintEl.textContent + "｜已逾期" : "評價期限：已逾期");
              }
            }
            return;
          }

          // 其他錯誤
          if (!resp.ok) {
            const t = await resp.text().catch(()=> "");
            const box = document.getElementById("status-alert-panel");
            box.innerHTML = `<div class="status-alert alert-danger"><b>送出失敗：</b>HTTP ${resp.status}<br>${escapeHTML(t)}</div>`;
            box.style.display = "block";
            return;
          }

          // 如果後端沒 redirect，也刷新一下
          window.location.reload();
        });
      }


      ratingPanel.style.display = "block";
    }

    async function loadRatingDeadlineHint(jobId) {
      const hintEl = document.getElementById("rating-deadline-hint");
      const form = document.querySelector("#rating-panel form");
      if (!hintEl || !form) return;

      try {
        const resp = await fetch(`/job/${jobId}/rating-window`, { credentials: "include" });
        if (!resp.ok) {
          hintEl.textContent = "評價期限：無法取得";
          return;
        }

        const w = await resp.json();

        // 後端若找不到結案事件，這裡會是 null
        if (!w.deadline_at) {
          hintEl.textContent = "評價期限：未提供（找不到結案時間紀錄）";
          return;
        }

        const deadline = new Date(w.deadline_at);
        const baseText = `評價期限至：${deadline.toLocaleString("zh-Hant-TW")}（結案後 ${w.deadline_days} 天）`;

        if (w.expired) {
          hintEl.textContent = baseText + "｜已逾期";
          // ✅ 鎖住整個表單（避免還能填）
          form.querySelectorAll("input, textarea, button").forEach(el => el.disabled = true);
        } else {
          hintEl.textContent = baseText;
        }
      } catch (e) {
        hintEl.textContent = "評價期限：載入失敗";
      }
    }


    async function loadRatingsPanel(jobId) {
      const box = document.getElementById("rating-result");
      if (!box) return;

      try {
        const resp = await fetch(`/job/${jobId}/ratings`, { credentials: "include" });

        if (resp.status === 401) {
          window.location.href = "/loginForm.html";
          return;
        }

        if (!resp.ok) {
          box.innerHTML = `<p class="muted">目前無法查看此案件評價紀錄。</p>`;
          return;
        }

        const payload = await resp.json();
        const ratings = payload?.data?.ratings ?? payload?.ratings ?? payload ?? [];


        if (ratings.length === 0) {
          box.innerHTML = `<p class="muted">目前尚無評價紀錄（可先送出你的評價）。</p>`;
          return;
        }

        let html = `
          <div style="border-top:1px solid #e5e7eb;margin-top:10px;padding-top:10px;">
            <b>此案件評價紀錄</b>
          </div>
        `;

        ratings.forEach(r => {
          const labels = RATING_DIM_LABELS_BY_TARGET[r.target_role] || ["維度1","維度2","維度3"];

          html += `
            <div style="border:1px solid #e5e7eb;border-radius:8px;padding:10px;margin-top:8px;background:#fff;">
              <div>
                <b>評價者：</b>${escapeHTML(r.rater_name || ("User#" + r.rater_id))}
                <span class="muted">（評價方向：${escapeHTML(r.target_role)}）</span>
              </div>

              <div class="muted" style="margin-top:6px;">
                ${labels[0]}：<b>${escapeHTML(r.dim1)}</b>　
                ${labels[1]}：<b>${escapeHTML(r.dim2)}</b>　
                ${labels[2]}：<b>${escapeHTML(r.dim3)}</b>
              </div>
              ${r.comment
                ? `<div style="margin-top:6px;"><b>評論：</b>${escapeHTML(r.comment)}</div>`
                : `<div class="muted" style="margin-top:6px;">（無評論）</div>`
              }
              <div class="muted" style="margin-top:6px;"><small>${escapeHTML(r.created_at)}</small></div>
            </div>
          `;
        });

        box.innerHTML = html;
      } catch (e) {
        console.error("loadRatingsPanel error:", e);
        box.innerHTML = `<p class="muted">評價載入失敗，請稍後再試。</p>`;
      }
    }

    // ----------------------------
    // Extension 初始化（只跑一次，不重複）
    // ----------------------------
    /*
    async function initExtensionPanels() {
      if (!jobId) return;

      const me = await fetchJSON("/me");
      if (!me) return;

      const data = await fetchJSON(`/job/${jobId}/detail`);
      if (!data) return;

      const job = data.job;
      //const role = data.user_job_role;

      // Issue 只給：委託人 or 得標承包人
      const isClient = (role === "client");
      const isWinnerContractor = (job.contractor_id && me.user_id === job.contractor_id);
      const canUseIssue = isClient || isWinnerContractor;
      const roleRaw = data.user_job_role;
      const role = roleRaw === "visitor_contractor" ? "visitor" : roleRaw;
      const isContractorLike = (roleRaw === "contractor" || roleRaw === "visitor_contractor");


      // extensionRole：避免 user_job_role 回 visitor 導致顯示錯
      const extensionRole =
        isClient ? "client" :
        isWinnerContractor ? "contractor" :
        (isContractorLike ? "visitor" : role);

      if (canUseIssue) {
        await loadIssuesPanel(job.id, extensionRole, job.status);
      } else {
        issuePanel.style.display = "none";
      }

      if (job.status === "closed") {
        renderRatingPanel(job, extensionRole);
        await loadRatingsPanel(job.id);
      } else {
        ratingPanel.style.display = "none";
      }
    }
    */
   async function initExtensionPanels() {
  if (!jobId) return;

  const me = await fetchJSON("/me");
  if (!me) return;

  const data = await fetchJSON(`/job/${jobId}/detail`);
  if (!data) return;

  const job = data.job;

  // ✅ 先處理 role
  const roleRaw = data.user_job_role;
  const role = (roleRaw === "visitor_contractor") ? "visitor" : roleRaw;
  const isContractorLike = (roleRaw === "contractor" || roleRaw === "visitor_contractor");

  // ✅ 再算權限
  const isClient = (role === "client");
  const isWinnerContractor = (job.contractor_id && me.user_id === job.contractor_id);
  const canUseIssue = isClient || isWinnerContractor;

  const extensionRole =
    isClient ? "client" :
    isWinnerContractor ? "contractor" :
    (isContractorLike ? "visitor" : role);

  if (canUseIssue) {
    await loadIssuesPanel(job.id, extensionRole, job.status);
  } else {
    issuePanel.style.display = "none";
  }

  if (job.status === "closed") {
    renderRatingPanel(job, extensionRole);
    await loadRatingDeadlineHint(job.id);
    await loadRatingsPanel(job.id);
    await lockRatingFormIfRated(job.id);
  } else {
    ratingPanel.style.display = "none";
  }
}


function openRatingModal(title, comments) {
  const modal = document.getElementById("ratingModal");
  const titleEl = document.getElementById("ratingModalTitle");
  const bodyEl = document.getElementById("ratingModalBody");

  titleEl.textContent = title;

  if (!comments || comments.length === 0) {
    bodyEl.innerHTML = `<p class="muted">（沒有留言）</p>`;
  } else {
    bodyEl.innerHTML = comments.map(c => `
      <div style="border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin-bottom:10px;background:#fff;">
        <div style="display:flex;justify-content:space-between;gap:10px;">
          <b>${escapeHTML(c.from_name || "匿名")}</b>
          <small class="muted">${c.created_at ? fmtDateTime(c.created_at) : ""}</small>
        </div>
        <div style="margin-top:6px; white-space:pre-wrap; word-break:break-word;">
          ${escapeHTML(c.comment || "")}
        </div>
      </div>
    `).join("");
  }

  modal.style.display = "block";
}

function closeRatingModal() {
  document.getElementById("ratingModal").style.display = "none";
}

document.addEventListener("click", (e) => {
  if (e.target && e.target.id === "ratingModalClose") closeRatingModal();
  if (e.target && e.target.id === "ratingModal") closeRatingModal();
});


    // ----------------------------
    // 啟動
    // ----------------------------
    loadPage();
    initExtensionPanels();

    window.addEventListener('pageshow', function (e) {
      if (e.persisted) location.reload();
    });


  </script>
  <div id="ratingModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9999;">
    <div style="max-width:700px; margin:8vh auto; background:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2);">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div id="ratingModalTitle" style="font-weight:700; font-size:18px;"></div>
        <button class="btn" type="button" id="ratingModalClose">關閉</button>
      </div>
      <div id="ratingModalBody" style="margin-top:12px;"></div>
    </div>
  </div>

</body>
</html>
