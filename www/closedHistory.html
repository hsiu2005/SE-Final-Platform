<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>已結案歷史專案 | TaskLink</title>
  <link rel="stylesheet" href="/appearance.css">
  <style>
    /* 頁面專屬排版微調 */
    .btn { white-space: nowrap; }
    
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    @media (max-width: 900px) {
      .toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-left, .toolbar-actions {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      }
    }
  </style>
</head>
<body class="page">
  <div class="page-inner" style="max-width: 1100px;">

    <header class="page-header">
      <div>
        <h1 class="page-title">已結案歷史專案</h1>
        <p class="page-subtitle">
          查看所有已經結束並歸檔的案件記錄。
        </p>
      </div>
      <div style="align-self: center;">
         <span id="who" class="who-tag">載入中...</span>
      </div>
    </header>

    <div class="toolbar">
      
      <div class="toolbar-left" id="backLinkContainer" style="display:flex;">
        </div>

      <div class="toolbar-actions" style="display:flex; gap:8px;">
        <a class="btn btn-secondary" href="/profile.html">個人頁面</a>
        <a class="btn btn-secondary btn-active" href="/closedHistory.html">歷史結案</a>
        <a class="btn btn-secondary" href="/history.html">操作紀錄</a>
        <a class="btn btn-secondary btn-logout" href="/logout">登出</a>
      </div>
    </div>

    <div class="card" style="width: 100%; margin-top: 10px; padding: 40px;"> 
      <div id="error" class="error-text"></div>

      <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div class="text-muted" style="font-size: 14px;">
           僅顯示狀態為 <span class="badge-pill st-green" style="font-size:12px;">已結案</span> 的案件
        </div>
        <button class="btn btn-secondary btn-sm" id="reloadBtn" type="button">↻ 重新整理</button>
      </div>

      <div class="table-wrapper">
        <table id="jobsTable" class="table">
          <thead>
            <tr>
              <th style="width: 80px;">案件 ID</th>
              <th>案件標題</th>
              <th style="width: 120px;">狀態</th>
              <th style="width: 180px;">最後更新時間</th>
              <th style="width: 100px; text-align: left;">動作</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div id="empty" class="text-muted" style="display:none; text-align:center; padding: 60px 0;">
        目前沒有已結案的歷史專案
      </div>
    </div>
  </div>

  <script>
    const whoEl = document.getElementById("who");
    const errorEl = document.getElementById("error");
    const rowsEl = document.getElementById("rows");
    const emptyEl = document.getElementById("empty");
    const reloadBtn = document.getElementById("reloadBtn");
    const backLinkContainer = document.getElementById("backLinkContainer");

    const escapeHTML = s => s==null ? "" : String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const fmtDateTime = s => s ? new Date(s).toLocaleString("zh-Hant-TW") : "—";

    async function fetchJSON(url, options={}) {
      const resp = await fetch(url, { credentials: "include", ...options });
      if (resp.status === 401) { window.location.href="/loginForm.html"; return null; }
      if (resp.redirected) { window.location.href = resp.url; return null; }
      if (!resp.ok) {
        const t = await resp.text().catch(()=> "");
        errorEl.textContent = `API 錯誤 ${resp.status}: ${t}`;
        return null;
      }
      return await resp.json();
    }

    function pickItems(payload) {
      return payload?.data?.items ?? payload?.items ?? payload ?? [];
    }

    async function loadClosedHistory() {
      errorEl.textContent = "";
      rowsEl.innerHTML = "";
      emptyEl.style.display = "none";

      const me = await fetchJSON("/me");
      if (!me) return;

      const roleText = me.role === 'client' ? '委託人' : '承包人';
      whoEl.textContent = `${roleText} · ${me.username}`;

      // 1. 動態生成「返回」按鈕
      if (me.role === "client") {
        backLinkContainer.innerHTML = `<a class="btn btn-secondary" href="/clientJobs.html">回我的案件</a>`;
      } else {
        backLinkContainer.innerHTML = `<a class="btn btn-secondary" href="/contractorMyJobs.html">回我的報價/案件</a>`;
      }

      let listUrl = "";
      if (me.role === "client") listUrl = "/client/jobs";
      else if (me.role === "contractor") listUrl = "/contractor/my-jobs";
      else {
        errorEl.textContent = "此頁僅提供給委託人/承包人使用。";
        return;
      }

      const data = await fetchJSON(listUrl);
      if (!data) return;

      let items = pickItems(data);

      // 3. 篩選 closed
      items = items.filter(j => (j.status || "") === "closed");

      if (items.length === 0) {
        emptyEl.style.display = "block";
        return;
      }

      // 4. 排序
      items.sort((a,b) => {
        const at = new Date(a.updated_at || a.created_at || 0).getTime();
        const bt = new Date(b.updated_at || b.created_at || 0).getTime();
        return bt - at;
      });

      for (const j of items) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="text-muted" style="font-size: 14px;">#${escapeHTML(j.id)}</td>
          <td>
             <span class="job-title-text">${escapeHTML(j.title || "")}</span>
          </td>
          <td><span class="badge-pill st-green">已結案</span></td>
          <td class="text-muted" style="font-size: 13px;">${fmtDateTime(j.updated_at || j.created_at)}</td>
          <td style="text-align: right;">
            <a class="btn btn-secondary btn-sm" href="/jobDetail.html?job_id=${encodeURIComponent(j.id)}">查看詳情</a>
          </td>
        `;
        rowsEl.appendChild(tr);
      }
    }

    reloadBtn.addEventListener("click", loadClosedHistory);
    loadClosedHistory();

    window.addEventListener("pageshow", function (e) {
      if (e.persisted) location.reload();
    });
  </script>
</body>
</html>