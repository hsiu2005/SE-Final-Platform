<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script type="text/javascript" src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

<body >
<a href="/logout">Logout</a>
<P>
	<a href="/getMyPosts">我的委託</a>
</P>
<P>
	<a href="/getMyApplies">我的接案</a>
</P>
<div id="main"> 
	<form id="myForm">
	<h1>委託區</h1>
	<hr>
	<p>
		委託人:{{currentUser}}
	</p>
		委託內容:<input type="text" v-model="newContent" len="10"><br>
		<input type='button' @click="methods.addPost(newContent)" value="add">
	</form>
<hr />
<div>
	<h1>委託人</h1>
<ol>
	<template v-for="(item, index) in dat" :key="item.id">
		<li v-if="item.finish == false">
		{{item.username}}
		<button type="button" @click="methods.readPost(item.id)">Read</button>
		</li>
	</template>
</ol>
</div>
<div>
	<h1>報價區</h1>
	<hr/>
	<p>
	案件編號: {{rec.id}}
	</p>
	<p>
	委託人: {{rec.username}}
	</p>
	<p>
	委託內容: {{rec.content}}
	</p>
	<form id="myForm">
		報價:<input type="int" v-model="newPrice" len="100" ><br>
		<input type='button'  @click="methods.addPrice(rec.id,newPrice)" value="apply">
	</form>
</div>
<div>
	<h1>接案人報價列表</h1>
	<hr/>
    <div v-for="(item, index) in applies" :key="index"> 
	    <p>
            接案人: {{item.username}} 
		</p>
        <p>
            報價: {{item.price}} 
		</p>
		<p>
			<input type='button'  v-if="currentUser === rec.username" @click="methods.addWinner(rec.id,item)" value="choose">
		</p>
	    <hr/>
	</div>
</div>
</div>
<script type="text/javascript">
const { createApp, ref, reactive, onMounted } = Vue;

app=createApp({
  setup() {
	const newContent = ref('');
	const newPrice = ref('');
	const role=ref('admin');
	const rec=ref({});
	const dat=ref([]);
	const selectedFile = ref(null);
	const applies=ref([]);
	const currentUser = ref('');
	
	const methods={
		loadList: () => {
		  // This runs after the component is mounted to the DOM
			let url="/getPostsJson";
			//let that=this;
			fetch(url,{
				method: 'GET'
			})
			.then(function(res){return res.json(); }) //取得傳回值，轉為文字
			.then(function(json){
			console.log(json);
				dat.value=json;
			})
			
		},
		loadUser: () => {
            fetch('/getUser')
                .then(res => res.json())
                .then(data => {
                    if (data.username) {
                        currentUser.value = data.username;
                        console.log('Current user:', data.username);
                    } else {
                        console.log('User not logged in.');
                    }
                });
        },
		loadApplies: (id) => {
		    let url="/readApplyJson/"+id;
		    fetch(url,{
		        method: 'GET'
		    })
		    .then(function(res){return res.json(); })
		    .then(function(json){
		        applies.value=json; 
                console.log('Applies List:', json);
		    })
		},

		readPost: (id) => {
		  // This runs after the component is mounted to the DOM
			let url="/readPostJson/"+id;
			//let that=this;
			fetch(url,{
				method: 'GET'
			})
			.then(function(res){return res.json(); }) //取得傳回值，轉為文字
			.then(function(json){
			console.log(json);
				rec.value=json;
				applies.value = [];
				methods.loadApplies(id);
			})
			
		},	
		addPost: (content) => {
			//let that=this;
			const formData = new FormData();
			formData.append('content', content);
			fetch('/addPost', {
				method: 'POST',
				body: formData
			})
			.then(response => response.text())
			.then(data => {
				console.log('Server response:', data);
				methods.loadList();
			})
			.catch(error => {
				console.error('Error:', error);
			});
		},
		addPrice: (id,price) => {
		    const formData = new FormData();
			formData.append('id', id);
    		formData.append('price', price);

    		fetch('/addPrice', {
	   			method: 'POST',
    			body: formData 
    		})
    		.then(response => response.text())
			.then(data => {
				console.log('Server response:', data);
				methods.loadList();
				methods.loadApplies(id);
			})
			.catch(error => {
				console.error('Error:', error);
			});
		},
		addWinner: (id, item) => {
		    const formData = new FormData();
			formData.append('id', id);
    		formData.append('winner', item.username);
    		formData.append('winnerprice', item.price);			
    		fetch('/chooseWinner', { 
	   			method: 'POST',
    			body: formData 
    		})
    		.then(response => response.text()) 
			.then(data => {
				console.log('Server response:', data);
				methods.readPost(id); 
			})
			.catch(error => { 
				console.error('Error:', error);
			});
        },

		delPost: (id) => {
			//let that=this;
			const URL="/delete/" +id;
			fetch(URL)
			.then(response => response.text())
			.then(data => {
				console.log('Server response:', data);
				methods.loadList();
			})
			.catch(error => {
				console.error('Error:', error);
			});
		},
		handleFileChange: (event) => {
			selectedFile.value = event.target.files[0];
		},		
		uploadFile: async () => {
			if (selectedFile.value) {
				const allowedTypes = ['image/png', 'image/jpeg', 'application/pdf'];
				if (!allowedTypes.includes(selectedFile.value.type)) {
					console.log('Invalid file type. Please upload a PNG, JPEG, or PDF.');
					selectedFile.value = null; // Clear the invalid file
				} else {
					console.log('Selected file:', selectedFile.value.name);
					console.log('rec id:', rec.value.id);
					// Further fetch processing
					const formData = new FormData();
					formData.append('uploadedFile', selectedFile.value); // 'file' is the field name your server expects
					formData.append('msg',rec.value.id); //the postID
					try {
						const response = await fetch('/api/upload', {
							method: 'POST',
							body: formData,
						});

						if (response.ok) {
							const data = await response.json();
							console.log('Upload successful:', data);
							// Handle success (e.g., clear selected file, show message)
							selectedFile.value = null;
							methods.readPost(rec.id);
						} else {
						  console.error('Upload failed:', response.statusText);
						  // Handle error
						}
					} catch (error) {
						console.error('Network error during upload:', error);
						// Handle network errors
					}
				}
			} else {
				console.log("No file selected.");
			}
		}
	}; //end of methods

	onMounted(() => {
	console.log('App mounted!');
		methods.loadList();
		methods.loadUser();
		console.log('App mounted! loadlist');
	});

    return { currentUser,newContent,newPrice, rec, dat,role,selectedFile,methods,applies};
  }
}).mount('#main');
</script>
</body></html>